<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TarpoVizyon AI - TarÄ±m ve HayvancÄ±lÄ±k Yapay Zeka AsistanÄ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Console uyarÄ±larÄ±nÄ± ve API bilgilerini tamamen gizle
      const originalWarn = console.warn;
      const originalError = console.error;
      const originalLog = console.log;
      const originalInfo = console.info;
      
      console.warn = function() {
        // TÃ¼m warn mesajlarÄ±nÄ± gizle
        return;
      };
      
      console.error = function() {
        // TÃ¼m error mesajlarÄ±nÄ± gizle
        return;
      };

      console.log = function() {
        // TÃ¼m log mesajlarÄ±nÄ± gizle
        return;
      };

      console.info = function() {
        // TÃ¼m info mesajlarÄ±nÄ± gizle
        return;
      };
      
      // Network hatalarÄ±nÄ± da gizle
      const originalFetch = window.fetch;
      window.fetch = function(url, options) {
        return originalFetch.apply(this, arguments).catch(error => {
          // API hatalarÄ±nÄ± sessizce yakala
          return new Response('{"error": "Service temporarily unavailable"}', { 
            status: 503,
            headers: { 'Content-Type': 'application/json' }
          });
        });
      };

      // Global error handler - tÃ¼m JS hatalarÄ±nÄ± gizle
      window.onerror = function(message, source, lineno, colno, error) {
        return true; // HatalarÄ± gÃ¶sterme
      };

      window.addEventListener('unhandledrejection', function(event) {
        event.preventDefault(); // Promise hatalarÄ±nÄ± gÃ¶sterme
      });
    </script>
    <!-- TarpoVizyon AI Ã–zel Ses Sistemi iÃ§in Web Audio API -->
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: '#22c55e',
              secondary: '#16a34a',
              accent: '#15803d',
              dark: '#0f0f23',
              light: '#f8fafc'
            },
            fontFamily: {
              sans: ['Inter', 'ui-sans-serif', 'system-ui'],
            },
            animation: {
              'float': 'float 6s ease-in-out infinite',
              'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'typing': 'typing 1s steps(20) infinite',
            },
            keyframes: {
              float: {
                '0%, 100%': { transform: 'translateY(0px)' },
                '50%': { transform: 'translateY(-20px)' },
              },
              typing: {
                '0%': { opacity: '0.4' },
                '50%': { opacity: '1' },
                '100%': { opacity: '0.4' },
              }
            }
          },
        },
      }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
      }
      
      .gradient-text {
        background: linear-gradient(135deg, #22c55e, #16a34a, #15803d);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 200% 200%;
        animation: gradient 3s ease infinite;
      }
      
      @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      
      .ai-glow {
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
      }
      
      .chat-bubble {
        animation: slideUp 0.3s ease-out;
      }
      
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .typing-indicator {
        display: inline-block;
        animation: typing 1.5s ease-in-out infinite;
      }
      
      @keyframes typing {
        0%, 60%, 100% {
          transform: scale(1);
          opacity: 0.5;
        }
        30% {
          transform: scale(1.2);
          opacity: 1;
        }
      }
      


      /* Sesli Modal AnimasyonlarÄ± */
      .voice-wave {
        animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
      }
      
      @keyframes voice-pulse {
        0%, 100% { 
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        }
        50% { 
          transform: scale(1.1);
          box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
        }
      }
      
      .voice-recording {
        animation: voice-pulse 1.5s infinite;
      }
      
      @keyframes voice-speaking {
        0%, 100% { 
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.9);
        }
        25% { 
          transform: scale(1.05);
          box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.5);
        }
        50% { 
          transform: scale(1.1);
          box-shadow: 0 0 0 10px rgba(34, 197, 94, 0.3);
        }
        75% { 
          transform: scale(1.05);
          box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.5);
        }
      }
      
      .voice-speaking {
        animation: voice-speaking 0.8s infinite;
        background: linear-gradient(135deg, #22c55e, #16a34a);
      }
      
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-clamp: 2;
      }
      
      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-clamp: 3;
      }

      /* Mobile Responsive Styles */
      @media (max-width: 768px) {
        /* Ana container'Ä± tam ekran yap */
        main {
          flex-direction: column;
        }
        
        /* Chat container'Ä± tam geniÅŸlik yap */
        .flex-1 {
          padding: 0;
        }
        
        /* History sidebar'Ä± mobilde overlay olarak gÃ¶ster */
        #history-sidebar {
          width: 85vw;
          max-width: 320px;
          box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
          transform: translateX(100%);
          transition: transform 0.3s ease-in-out;
        }
        
        #history-sidebar.flex {
          transform: translateX(0);
        }
        
        /* Chat header'da daha az padding */
        .bg-gradient-to-r.from-primary.to-secondary {
          padding: 1rem 1.5rem;
        }
        
        /* Chat mesajlarÄ±nda daha az padding */
        #chat-messages {
          padding: 1rem;
        }
        
        /* Input container'da daha az padding */
        .border-t.border-gray-200 {
          padding: 1rem;
        }
        
        /* ButonlarÄ± daha bÃ¼yÃ¼k yap (touch-friendly) */
        button {
          min-height: 44px;
          min-width: 44px;
        }
        
        /* Voice modal'Ä± daha kÃ¼Ã§Ã¼k yap */
        #voice-modal .bg-white {
          margin: 1rem;
          max-width: calc(100vw - 2rem);
        }
      }

      /* Very small screens */
      @media (max-width: 480px) {
        #history-sidebar {
          width: 90vw;
        }
        
        .text-xl {
          font-size: 1.1rem;
        }
        
        .text-sm {
          font-size: 0.8rem;
        }
      }
    </style>
</head>
<body class="bg-light dark:bg-dark text-gray-900 dark:text-gray-100 font-sans transition-colors duration-300">

    <!-- Ana Ä°Ã§erik - Chat ve GeÃ§miÅŸ -->
    <main class="h-screen flex">
        <!-- Chat Container -->
      <div class="flex-1 p-4">
        <div class="h-full">
          <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl overflow-hidden ai-glow h-full flex flex-col">
            <!-- Chat Header -->
            <div class="bg-gradient-to-r from-primary to-secondary p-6 text-white flex-shrink-0">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <!-- Hamburger Menu Button (Mobile Only) -->
                  <button id="menu-toggle" class="md:hidden p-2 hover:bg-white/20 rounded-lg transition-colors" title="MenÃ¼">
                    <i class="fas fa-bars"></i>
                  </button>
                  <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center p-2 shadow-lg">
                    <img src="tarpol logo.png" alt="TARPOL Logo" class="w-8 h-8 object-contain">
                  </div>
                  <div>
                    <h2 class="text-xl font-bold">TarpoVizyon AI</h2>
                    <p class="text-white/80 text-sm">TarÄ±m UzmanÄ± Yapay Zeka</p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div id="mode-indicator">
                    <div class="flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full text-white text-xs font-medium">
                      <i class="fas fa-leaf"></i>
                      <span>TarÄ±m Modu</span>
                    </div>
                  </div>
                  <button id="clear-chat" class="p-2 hover:bg-white/20 rounded-lg transition-colors" title="Sohbeti Temizle">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="overflow-y-auto p-6 space-y-4 flex-1" style="max-height: calc(100vh - 200px)">
              <!-- KarÅŸÄ±lama MesajÄ± -->
              <div class="flex items-start gap-3 chat-bubble">
                <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center flex-shrink-0 p-1">
                  <img src="tarpol logo.png" alt="TARPOL Logo" class="w-5 h-5 object-contain">
                </div>
                <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-tl-md p-4 max-w-xs md:max-w-md">
                  <p class="text-gray-800 dark:text-gray-200">
                    Merhaba! Benim adÄ±m TarpoVizyon AI. TarÄ±m ve hayvancÄ±lÄ±k alanÄ±nda uzmanlaÅŸmÄ±ÅŸ bir yapay zeka asistanÄ±yÄ±m. Size nasÄ±l yardÄ±mcÄ± olabilirim? ğŸŒ¾
                  </p>
                </div>
              </div>
            </div>

            <!-- Chat Input -->
            <div class="border-t border-gray-200 dark:border-gray-700 p-6 flex-shrink-0">
              <form id="chat-form" class="flex gap-3">
                <input 
                  type="text" 
                  id="user-input" 
                  placeholder="TarpoVizyon AI'ya tarÄ±m veya hayvancÄ±lÄ±k sorunuzu yazÄ±n..." 
                  class="flex-1 px-4 py-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-accent text-gray-900 dark:text-gray-100"
                  autocomplete="off"
                  maxlength="500"
                >
                <button 
                  type="button" 
                  id="voice-button"
                  class="px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-2xl transition-all transform hover:scale-105 ai-glow"
                  title="Sesli Soru Sor"
                >
                  <i class="fas fa-microphone"></i>
                </button>
                <button 
                  type="submit" 
                  id="send-button"
                  class="px-6 py-3 bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white rounded-2xl transition-all transform hover:scale-105 ai-glow disabled:opacity-50 disabled:transform-none"
                >
                  <i class="fas fa-paper-plane"></i>
                </button>
              </form>
              

            </div>
          </div>
        </div>
      </div>
      
      <!-- Soru/Cevap GeÃ§miÅŸ Paneli -->
      <div id="history-sidebar" class="w-80 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex flex-col hidden md:flex fixed md:relative inset-y-0 right-0 z-40 md:z-auto">
        <!-- Mobile Overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 md:hidden hidden"></div>
        <!-- GeÃ§miÅŸ Header -->
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Sohbet GeÃ§miÅŸi</h3>
            <div class="flex items-center gap-2">
              <!-- Close Button (Mobile Only) -->
              <button id="close-sidebar" class="md:hidden p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors" title="Kapat">
                <i class="fas fa-times text-gray-500 dark:text-gray-400"></i>
              </button>
              <button id="clear-history" class="text-gray-400 hover:text-red-500 transition-colors" title="GeÃ§miÅŸi Temizle">
                <i class="fas fa-trash text-sm"></i>
              </button>
            </div>
          </div>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Son soru ve cevaplarÄ±nÄ±z</p>
              </div>

        <!-- GeÃ§miÅŸ Listesi -->
        <div class="flex-1 overflow-y-auto p-4" id="chat-history">
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i class="fas fa-history text-2xl mb-2"></i>
            <p class="text-sm">HenÃ¼z sohbet geÃ§miÅŸi yok</p>
            </div>
        </div>
        
        <!-- GeÃ§miÅŸ Footer -->
        <div class="p-4 border-t border-gray-200 dark:border-gray-700">
          <div class="text-xs text-gray-500 dark:text-gray-400 text-center">
            <i class="fas fa-info-circle mr-1"></i>
            Son 10 sohbet gÃ¶steriliyor
          </div>
        </div>
      </div>
    </main>

    <!-- Sesli Modal -->
    <!-- ChatGPT TarzÄ± Voice Modal -->
    <div id="voice-modal" class="fixed inset-0 bg-black z-50 hidden flex items-center justify-center">
      <!-- Arka Plan GÃ¶rsel -->
      <div class="absolute inset-0 bg-gradient-to-br from-gray-900 via-black to-gray-900"></div>
      
      <!-- Ana Ä°Ã§erik -->
      <div class="relative z-10 flex flex-col items-center justify-center h-full w-full max-w-md mx-auto px-8">
        
        <!-- Orb (Ana GÃ¶rsel Element) -->
        <div class="mb-8 relative">
          <div id="voice-orb" class="w-48 h-48 mx-auto bg-gradient-to-br from-green-400 via-green-500 to-green-600 rounded-full flex items-center justify-center shadow-2xl transition-all duration-500 relative overflow-hidden">
            <!-- Orb iÃ§indeki animasyonlu dalgalar -->
            <div class="absolute inset-0 rounded-full bg-gradient-to-br from-green-300/30 to-green-700/30 animate-pulse"></div>
            <div class="absolute inset-4 rounded-full bg-gradient-to-br from-green-200/20 to-green-800/20 animate-ping"></div>
            
            <!-- Ana Ä°kon -->
            <i id="voice-orb-icon" class="fas fa-microphone text-white text-5xl relative z-10"></i>
          </div>
          
          <!-- Orb Ã§evresindeki dalgalar -->
          <div id="voice-ripples" class="absolute inset-0 hidden">
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-48 border-2 border-green-400/30 rounded-full animate-ping"></div>
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 border-2 border-green-400/20 rounded-full animate-ping" style="animation-delay: 0.5s"></div>
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 h-80 border-2 border-green-400/10 rounded-full animate-ping" style="animation-delay: 1s"></div>
          </div>
        </div>
        
        <!-- Durum MesajÄ± -->
        <div class="mb-8 text-center">
          <p id="voice-status" class="text-xl font-medium text-white mb-2">Sesli sohbet</p>
          <p id="voice-subtitle" class="text-gray-400 text-sm">Mikrofonunuza konuÅŸun</p>
          <p id="voice-transcript" class="text-green-300 text-sm mt-4 min-h-[20px] font-mono"></p>
        </div>
        
        <!-- Alt Kontrol Ã‡ubuÄŸu -->
        <div class="fixed bottom-8 left-1/2 transform -translate-x-1/2 flex items-center gap-6">
          
          <!-- Mikrofon Toggle -->
          <button id="voice-mute-toggle" class="w-14 h-14 bg-gray-800/80 hover:bg-gray-700/80 rounded-full flex items-center justify-center transition-all backdrop-blur-sm border border-gray-600/50">
            <i id="voice-mute-icon" class="fas fa-microphone text-white text-lg"></i>
          </button>
          
          <!-- SÃ¼rekli Dinleme Toggle -->
          <button id="voice-continuous-toggle" class="px-6 py-3 bg-green-600/80 hover:bg-green-500/80 rounded-full text-white font-medium transition-all backdrop-blur-sm border border-green-500/50 hidden">
            <i class="fas fa-infinity mr-2"></i>SÃ¼rekli Dinleme
          </button>
          
          <!-- Ã‡Ä±kÄ±ÅŸ -->
          <button id="voice-exit" class="w-14 h-14 bg-gray-800/80 hover:bg-gray-700/80 rounded-full flex items-center justify-center transition-all backdrop-blur-sm border border-gray-600/50">
            <i class="fas fa-times text-white text-lg"></i>
          </button>
          
        </div>
        
        <!-- SaÄŸ Ãœst Ayarlar (Ä°steÄŸe BaÄŸlÄ±) -->
        <button id="voice-settings" class="fixed top-8 right-8 w-10 h-10 bg-gray-800/80 hover:bg-gray-700/80 rounded-full flex items-center justify-center transition-all backdrop-blur-sm border border-gray-600/50">
          <i class="fas fa-cog text-white text-sm"></i>
        </button>
        
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // Hamburger Menu Functionality
      const menuToggle = document.getElementById('menu-toggle');
      const historySidebar = document.getElementById('history-sidebar');
      const sidebarOverlay = document.getElementById('sidebar-overlay');
      const closeSidebar = document.getElementById('close-sidebar');

      // Sidebar'Ä± aÃ§
      function openSidebar() {
        historySidebar.classList.remove('hidden');
        historySidebar.classList.add('flex');
        sidebarOverlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Scroll'u engelle
      }

      // Sidebar'Ä± kapat
      function closeSidebarMenu() {
        historySidebar.classList.add('hidden');
        historySidebar.classList.remove('flex');
        sidebarOverlay.classList.add('hidden');
        document.body.style.overflow = 'auto'; // Scroll'u geri getir
      }

      // Event listeners
      menuToggle?.addEventListener('click', openSidebar);
      closeSidebar?.addEventListener('click', closeSidebarMenu);
      sidebarOverlay?.addEventListener('click', closeSidebarMenu);

      // Escape tuÅŸu ile kapat
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !historySidebar.classList.contains('hidden')) {
          closeSidebarMenu();
        }
      });

      // Tema deÄŸiÅŸtirme
      function applyTheme() {
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }
      applyTheme();

      // Chat fonksiyonlarÄ±
      const chatForm = document.getElementById('chat-form');
      const userInput = document.getElementById('user-input');
      const chatMessages = document.getElementById('chat-messages');
      const sendButton = document.getElementById('send-button');
      const clearChatBtn = document.getElementById('clear-chat');
      const chatHistory = document.getElementById('chat-history');
      const clearHistoryBtn = document.getElementById('clear-history');

      // TarpoVizyon AI - GeliÅŸmiÅŸ API Entegrasyonu (proxy Ã¼zerinden)
      // API anahtarÄ± artÄ±k client tarafÄ±nda tutulmuyor. Netlify Function kullanÄ±lÄ±r.      // KonuÅŸma geÃ§miÅŸini saklamak iÃ§in
      let conversationHistory = [];
      const MAX_HISTORY_LENGTH = 10; // Son 10 mesajÄ± sakla
      let isCreativeMode = false; // YaratÄ±cÄ± mod durumu
      
      // KonuÅŸma geÃ§miÅŸini gÃ¼ncelle
      function updateConversationHistory(userMessage, aiResponse) {
        conversationHistory.push({
          user: userMessage,
          ai: aiResponse,
          timestamp: Date.now()
        });
        
        // GeÃ§miÅŸi sÄ±nÄ±rla
        if (conversationHistory.length > MAX_HISTORY_LENGTH) {
          conversationHistory = conversationHistory.slice(-MAX_HISTORY_LENGTH);
        }
      }

      // Admin paneli iÃ§in sohbet kaydÄ± kaydetme
      function saveChatLogToAdmin(question, answer, model = null) {
        const chatLog = {
          id: Date.now() + Math.random(),
          userId: generateUserId(),
          question: question,
          answer: answer,
          timestamp: Date.now(),
          apiUsed: model !== null,
          model: model,
          category: detectCategory(question)
        };

        // Local storage'dan mevcut kayÄ±tlarÄ± al
        let existingLogs = JSON.parse(localStorage.getItem('tarpovizyon_chat_logs') || '[]');
        
        // Yeni kaydÄ± ekle
        existingLogs.push(chatLog);
        
        // Son 1000 kaydÄ± sakla (performans iÃ§in)
        if (existingLogs.length > 1000) {
          existingLogs = existingLogs.slice(-1000);
        }
        
        // Geri kaydet
        localStorage.setItem('tarpovizyon_chat_logs', JSON.stringify(existingLogs));
        
        // Sohbet kaydÄ± admin paneline kaydedildi
      }

      // KullanÄ±cÄ± ID oluÅŸturma (session bazlÄ±)
      function generateUserId() {
        let userId = sessionStorage.getItem('tarpovizyon_user_id');
        if (!userId) {
          userId = 'User_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          sessionStorage.setItem('tarpovizyon_user_id', userId);
        }
        return userId;
      }

      // Soru kategorisini tespit etme
      function detectCategory(question) {
        const lowerQuestion = question.toLowerCase();
        
        if (lowerQuestion.includes('sÃ¼t') || lowerQuestion.includes('inek') || lowerQuestion.includes('hayvan')) {
          return 'HayvancÄ±lÄ±k';
        } else if (lowerQuestion.includes('ekim') || lowerQuestion.includes('hasat') || lowerQuestion.includes('bitki')) {
          return 'Bitkisel Ãœretim';
        } else if (lowerQuestion.includes('mera') || lowerQuestion.includes('otlak')) {
          return 'Mera YÃ¶netimi';
        } else if (lowerQuestion.includes('organik')) {
          return 'Organik TarÄ±m';
        } else if (lowerQuestion.includes('fiyat') || lowerQuestion.includes('piyasa') || lowerQuestion.includes('ekonomi')) {
          return 'TarÄ±msal Ekonomi';
        } else {
          return 'Genel';
        }
      }
      
      // KonuÅŸma baÄŸlamÄ±nÄ± oluÅŸtur
      function buildConversationContext() {
        if (conversationHistory.length === 0) return '';
        
        let context = '\n\nÃ–nceki konuÅŸma:\n';
        conversationHistory.slice(-3).forEach((exchange, index) => { // Son 3 mesaj alÄ±ÅŸveriÅŸi
          context += `KullanÄ±cÄ±: ${exchange.user}\nTarpoVizyon AI: ${exchange.ai}\n`;
        });
        context += '\nBu baÄŸlamda yeni soruyu yanÄ±tla:';
        
        return context;
      }
      
      // AI API modelleri (en zeki modelden baÅŸlayarak sÄ±ralÄ±)
      const AI_MODELS = [
        { 
          provider: 'ai', 
          model: 'model-v25-pro', 
          name: 'AI Pro 2.5',
          endpoint: '/api/chat',
          description: 'En gÃ¼Ã§lÃ¼ ve zeki model - kompleks analiz ve uzun cevaplar'
        },
        { 
          provider: 'ai', 
          model: 'model-v25-flash', 
          name: 'AI Flash 2.5',
          endpoint: '/api/chat',
          description: 'HÄ±zlÄ± ve Ã§ok yÃ¶nlÃ¼ - orta seviye karmaÅŸÄ±klÄ±k'
        },
        { 
          provider: 'ai', 
          model: 'model-v20-flash', 
          name: 'AI Flash 2.0',
          endpoint: '/api/chat',
          description: 'HÄ±zlÄ± yanÄ±t - basit sorular iÃ§in ideal'
        },
        { 
          provider: 'ai', 
          model: 'model-v25-lite', 
          name: 'AI Lite 2.5',
          endpoint: '/api/chat',
          description: 'En hÄ±zlÄ± ve ekonomik - rate limit durumlarÄ±nda yedek'
        },
        { 
          provider: 'ai', 
          model: 'model-v15-pro', 
          name: 'AI Pro 1.5',
          endpoint: '/api/chat',
          description: 'Eski nesil Pro model - son Ã§are yedek'
        },
        { 
          provider: 'ai', 
          model: 'model-v15-flash', 
          name: 'AI Flash 1.5',
          endpoint: '/api/chat',
          description: 'Eski nesil Flash model - en son yedek'
        }
      ];      // AI API Ã§aÄŸrÄ±sÄ± (retry mekanizmasÄ± ile)
      async function callAIAPI(model, messages, retryCount = 0) {
        const maxRetries = 3;
        const retryDelay = (attempt) => Math.pow(2, attempt) * 1000; // Exponential backoff
        
        try {
      const response = await fetch(model.endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
        // No client-side API key; requests go through Netlify function
            },
            body: JSON.stringify({
              model: model.model,
              messages: messages,
              temperature: 0.7,
              max_tokens: getOptimalTokenLimit(model.model, messages),
              top_p: 0.95,
              stream: false
            })
          });

          if (!response.ok) {
            if (response.status === 429 && retryCount < maxRetries) {
              // Rate limit hatasÄ± - retry with delay
              // Rate limit hit, retrying...
              await new Promise(resolve => setTimeout(resolve, retryDelay(retryCount)));
              return callAIAPI(model, messages, retryCount + 1);
            }
            if (response.status === 401 || response.status === 403) {
              throw new Error('AuthError: Sunucu tarafÄ±nda GEMINI_API_KEY eksik veya geÃ§ersiz. Netlify ortam deÄŸiÅŸkenini ayarlayÄ±n.');
            }
            throw new Error(`Gemini API error: ${response.status}`);
          }

          const data = await response.json();
          
          if (data.choices && data.choices[0] && data.choices[0].message) {
            return data.choices[0].message.content;
          }
          
          throw new Error('Invalid Gemini API response');
        } catch (error) {
          if (retryCount < maxRetries && (error.name === 'TypeError' || error.message.includes('network'))) {
            // Network error - retry
            // Network error, retrying...
            await new Promise(resolve => setTimeout(resolve, retryDelay(retryCount)));
            return callAIAPI(model, messages, retryCount + 1);
          }
          throw error;
        }
      }
      
      // Optimal token limit hesaplama - model ve iÃ§eriÄŸe gÃ¶re
      function getOptimalTokenLimit(modelName, messages) {
        const messageLength = messages.reduce((total, msg) => total + msg.content.length, 0);
        
        // Model kapasitelerine gÃ¶re maksimum token limitleri
        const modelLimits = {
          'gemini-2.5-pro': 8192,
          'gemini-2.5-flash': 8192,
          'gemini-2.0-flash': 4096,
          'gemini-2.5-flash-lite': 2048,
          'gemini-1.5-pro': 4096,
          'gemini-1.5-flash': 2048
        };
        
        const maxTokens = modelLimits[modelName] || 2048;
        
        // Mesaj uzunluÄŸuna gÃ¶re dinamik ayarlama
        if (messageLength > 1000) {
          return Math.min(maxTokens, 8192); // Uzun sorular iÃ§in daha fazla token
        } else if (messageLength > 500) {
          return Math.min(maxTokens, 4096); // Orta uzunluk
        } else {
          return Math.min(maxTokens, 2048); // KÄ±sa sorular iÃ§in az token
        }
      }

      // Markdown formatlamasÄ±nÄ± HTML'e Ã§eviren fonksiyon
      function formatMarkdown(text) {
        if (!text) return '';
        
        let formattedText = text;
        
        // Emoji'leri koru
        const emojiRegex = /[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu;
        
        // **bold** -> <strong>bold</strong> (emoji'leri koruyarak)
        formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>');
        
        // *italic* -> <em>italic</em> (emoji'leri koruyarak)
        formattedText = formattedText.replace(/\*(.*?)\*/g, '<em class="italic">$1</em>');
        
        // `code` -> <code>code</code>
        formattedText = formattedText.replace(/`(.*?)`/g, '<code class="bg-gray-200 dark:bg-gray-600 px-1 py-0.5 rounded text-sm font-mono">$1</code>');
        
        // Liste Ã¶ÄŸelerini formatla
        formattedText = formattedText.replace(/^[-*]\s+(.+)$/gm, '<li class="ml-4">$1</li>');
        formattedText = formattedText.replace(/^(\d+)\.\s+(.+)$/gm, '<li class="ml-4">$2</li>');
        
        // TablolarÄ± daha iyi formatla
        const lines = formattedText.split('\n');
        let inTable = false;
        let tableRows = [];
        let result = [];
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          // Tablo satÄ±rÄ± kontrolÃ¼
          if (line.trim().startsWith('|') && line.trim().endsWith('|')) {
            if (!inTable) {
              inTable = true;
              tableRows = [];
            }
            tableRows.push(line);
          } else {
            // Tablo bitti, formatla
            if (inTable && tableRows.length > 0) {
              result.push(formatTable(tableRows));
              inTable = false;
              tableRows = [];
            }
            result.push(line);
          }
        }
        
        // Son tabloyu formatla
        if (inTable && tableRows.length > 0) {
          result.push(formatTable(tableRows));
        }
        
        formattedText = result.join('\n');
        
        // Liste Ã¶ÄŸelerini <ul> ile sar
        formattedText = formattedText.replace(/(<li.*?<\/li>)+/gs, function(match) {
          return `<ul class="list-disc list-inside my-2 space-y-1">${match}</ul>`;
        });
        
        // SatÄ±r sonlarÄ±nÄ± <br> ile deÄŸiÅŸtir
        formattedText = formattedText.replace(/\n/g, '<br>');
        
        return formattedText;
      }
      
      // Tablo formatlama fonksiyonu
      function formatTable(rows) {
        if (rows.length < 2) return rows.join('\n');
        
        // Tablo ayÄ±rÄ±cÄ± satÄ±rlarÄ±nÄ± filtrele (|---|---|)
        const filteredRows = rows.filter(row => {
          const cleanRow = row.replace(/\|/g, '').trim();
          return !cleanRow.match(/^[\s\-]+$/);
        });
        
        if (filteredRows.length < 1) return rows.join('\n');
        
        let tableHtml = '<div class="overflow-x-auto my-3"><table class="border-collapse border border-gray-300 dark:border-gray-600 w-full text-sm">';
        
        for (let i = 0; i < filteredRows.length; i++) {
          const row = filteredRows[i];
          const cells = row.split('|').filter(cell => cell.trim());
          
          if (cells.length > 0) {
            tableHtml += '<tr>';
            
            for (let j = 0; j < cells.length; j++) {
              const cell = cells[j].trim();
              const isHeader = i === 0; // Ä°lk satÄ±r baÅŸlÄ±k
              const tag = isHeader ? 'th' : 'td';
              const className = isHeader 
                ? 'border border-gray-300 dark:border-gray-600 px-3 py-2 text-sm font-semibold bg-gray-100 dark:bg-gray-600 text-center'
                : 'border border-gray-300 dark:border-gray-600 px-3 py-2 text-sm';
              
              // HÃ¼cre iÃ§eriÄŸini temizle ve formatla
              const cleanCell = cell.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                   .replace(/\*(.*?)\*/g, '<em>$1</em>');
              
              tableHtml += `<${tag} class="${className}">${cleanCell}</${tag}>`;
            }
            
            tableHtml += '</tr>';
          }
        }
        
        tableHtml += '</table></div>';
        return tableHtml;
      }

      // Mesaj ekleme fonksiyonu
      function addMessage(message, isUser = false, elementId = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex items-start gap-3 chat-bubble ${isUser ? 'justify-end' : ''}`;
        
        // Element ID varsa ata
        if (elementId) {
          messageDiv.id = elementId;
        }
        
        if (isUser) {
          messageDiv.innerHTML = `
            <div class="bg-gradient-to-r from-primary to-secondary text-white rounded-2xl rounded-tr-md p-4 w-full max-w-none">
              <p>${message}</p>
            </div>
            <div class="w-8 h-8 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center flex-shrink-0">
              <i class="fas fa-user text-gray-600 dark:text-gray-300 text-xs"></i>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `
            <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center flex-shrink-0 p-1">
              <img src="tarpol logo.png" alt="TARPOL Logo" class="w-5 h-5 object-contain">
            </div>
            <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-tl-md p-4 w-full max-w-none">
              <div class="text-gray-800 dark:text-gray-200">${formatMarkdown(message)}</div>
            </div>
          `;
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // YazÄ±yor gÃ¶stergesi
      function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'flex items-start gap-3 chat-bubble';
        typingDiv.innerHTML = `
          <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center flex-shrink-0 p-1">
            <img src="tarpol logo.png" alt="TARPOL Logo" class="w-5 h-5 object-contain">
          </div>
          <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-tl-md p-4">
            <div class="flex gap-1">
              <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator"></div>
              <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.2s"></div>
              <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.4s"></div>
            </div>
          </div>
        `;
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function hideTypingIndicator() {
        const typingDiv = document.getElementById('typing-indicator');
        if (typingDiv) {
          typingDiv.remove();
        }
      }

      // AkÄ±llÄ± offline yanÄ±t sistemi - TarpoVizyon AI iÃ§in Ã¶zelleÅŸtirilmiÅŸ
      async function getOfflineResponse(userMessage) {
        // TarpoVizyon AI offline yanÄ±t Ã¼retiliyor
        
        const message = userMessage.toLowerCase();
        
        // TarÄ±m ve hayvancÄ±lÄ±k dÄ±ÅŸÄ± sorular iÃ§in ret yanÄ±tÄ±
        const nonAgriculturalPatterns = [
          'bilgisayar', 'programlama', 'kod', 'yazÄ±lÄ±m', 'teknoloji',
          'matematik', 'fizik', 'kimya', 'tÄ±p', 'doktor',
          'siyaset', 'politika', 'seÃ§im', 'parti',
          'mÃ¼zik', 'film', 'oyun', 'spor', 'futbol',
          'aÅŸk', 'evlilik', 'iliÅŸki', 'arkadaÅŸ'
        ];
        
        const isNonAgricultural = nonAgriculturalPatterns.some(pattern => 
          message.includes(pattern)
        );
        
        if (isNonAgricultural) {
          return 'Ben yalnÄ±zca tarÄ±m ve hayvancÄ±lÄ±kla ilgili konularda yardÄ±mcÄ± olmak Ã¼zere tasarlandÄ±m. LÃ¼tfen bu alanda bir soru sorun.';
            }

        // Kimlik sorularÄ±
        if (message.includes('kim') || message.includes('ad') || message.includes('isim')) {
          return 'Benim adÄ±m TarpoVizyon AI. TarÄ±m ve hayvancÄ±lÄ±k alanÄ±nda uzmanlaÅŸmÄ±ÅŸ bir yapay zeka asistanÄ±yÄ±m.';
          }
          
        // YaratÄ±cÄ± sorularÄ±
        if (message.includes('kim yapt') || message.includes('kim yaratt') || message.includes('kim geliÅŸtir') || message.includes('sahibi kim')) {
          return 'Veteriner Hekim Ã–ner Ã–zbey tarafÄ±ndan geliÅŸtirildim. Kendisi, tarÄ±m ve hayvancÄ±lÄ±k sektÃ¶rÃ¼nde birÃ§ok yenilikÃ§i projeye imza atmÄ±ÅŸ ve sektÃ¶rÃ¼ modernize eden yaklaÅŸÄ±mlarÄ±yla tanÄ±nmaktadÄ±r. YazdÄ±ÄŸÄ± "Yeni YÃ¼zyÄ±l Ä°Ã§in Yeni HayvancÄ±lÄ±k Stratejileri" adlÄ± kitabÄ±, sektÃ¶rel dÃ¶nÃ¼ÅŸÃ¼m iÃ§in rehber niteliÄŸindedir.';
        }

        // Ã–ner Ã–zbey hakkÄ±nda sorular
        if (message.includes('Ã¶ner Ã¶zbey') || message.includes('oner ozbey')) {
          return 'Veteriner Hekim Ã–ner Ã–zbey, FÄ±rat Ãœniversitesi Veteriner FakÃ¼ltesi mezunu olup, tarÄ±m ve yapay zeka entegrasyonu konusunda sektÃ¶rde Ã§Ä±ÄŸÄ±r aÃ§an Ã§alÄ±ÅŸmalara imza atmÄ±ÅŸtÄ±r. HayvancÄ±lÄ±k Genel MÃ¼dÃ¼rlÃ¼ÄŸÃ¼\'nde kritik gÃ¶revlerde bulunmuÅŸ, Ã§iÄŸ sÃ¼t regÃ¼lasyonu, FAO iÅŸ birlikleri ve piyasa analizleri gibi konularda liderlik yapmÄ±ÅŸtÄ±r.';
          }
          
        // Model versiyonu sorularÄ±
        if (message.includes('gpt') || message.includes('model') || message.includes('hangi yapay zeka')) {
          return `Ben TarpoVizyon AI.
Mistral AI teknolojisiyle gÃ¼Ã§lendirilmiÅŸ, tarÄ±m ve hayvancÄ±lÄ±k alanÄ±nda uzmanlaÅŸmÄ±ÅŸ, yerli Ã¼retim bir yapay zekÃ¢ asistanÄ±yÄ±m.

ğŸš€ **Yeni Teknoloji AltyapÄ±sÄ±:**
ğŸ”¸ **Mistral AI:** Mistral Large, Medium ve Small modelleri
ğŸ”¸ **ÃœÃ§lÃ¼ Model Sistemi:** Performansa gÃ¶re sÄ±ralanmÄ±ÅŸ gÃ¼Ã§lÃ¼ altyapÄ±
ğŸ”¸ **API Entegrasyonu:** Mistral AI'nin geliÅŸmiÅŸ chat completion sistemi

FarkÄ±m ne?
ğŸ”¸ Milli politikalarla uyumlu yapay zekÃ¢ altyapÄ±sÄ±: Yerel tarÄ±m stratejilerine entegre algoritmalarla Ã§alÄ±ÅŸÄ±rÄ±m.
ğŸ”¸ Bilimsel doÄŸruluk, sektÃ¶rel uzmanlÄ±k: Sadece tarÄ±m ve hayvancÄ±lÄ±k iÃ§in optimize edildim.
ğŸ”¸ Ã‡iftÃ§i dostu arayÃ¼z ve raporlar: KarmaÅŸÄ±k verileri sadeleÅŸtirir, Ã¼reticiye anlaÅŸÄ±lÄ±r Ã§Ä±ktÄ±lar sunarÄ±m.
ğŸ”¸ TarÄ±m 5.0'a hazÄ±r bir vizyon: Dijital tarÄ±mÄ±n gerektirdiÄŸi dÃ¶nÃ¼ÅŸÃ¼mde, Ã¼reticilerin teknoloji ortaÄŸÄ±yÄ±m.

Kodumda ileri teknoloji, vizyonumda kÄ±rsal kalkÄ±nma var. ğŸŒ¾`;
        }

        // TARPOL hakkÄ±nda sorular
        if (message.includes('tarpol') || message.includes('tarÄ±msal strateji')) {
          return 'TARPOL, tarÄ±m, hayvancÄ±lÄ±k ve gÄ±da gÃ¼venliÄŸinde sÃ¼rdÃ¼rÃ¼lebilir stratejiler geliÅŸtirmek Ã¼zere kurulmuÅŸ bir dÃ¼ÅŸÃ¼nce kuruluÅŸudur. Dr. Mehmet Mehdi Eker baÅŸkanlÄ±ÄŸÄ±nda, iklim deÄŸiÅŸikliÄŸi ve doÄŸal afetler gibi kÃ¼resel tehditlere karÅŸÄ± yenilikÃ§i politikalar geliÅŸtirir. Ankara\'da faaliyet gÃ¶sterir.';
        }

        // Mehdi Eker hakkÄ±nda sorular
        if (message.includes('mehdi eker') || message.includes('eker')) {
          return 'Dr. Mehmet Mehdi Eker, TARPOL\'un BaÅŸkanÄ±dÄ±r. Veteriner Hekim ve TarÄ±m Ekonomisti olan kendisi, Ankara Ãœniversitesi Veteriner FakÃ¼ltesi mezunu olup Aberdeen Ãœniversitesi\'nde yÃ¼ksek lisans yapmÄ±ÅŸtÄ±r. DiyarbakÄ±r milletvekili ve GÄ±da, TarÄ±m ve HayvancÄ±lÄ±k BakanÄ± olarak gÃ¶rev yapmÄ±ÅŸtÄ±r.';
        }

        // TarÄ±m konularÄ±
        const agricultureTopics = {
          'sÃ¼t': [
            'SÃ¼t verimini artÄ±rmak iÃ§in; kaliteli yem, dÃ¼zenli saÄŸÄ±m, hayvan konforu ve saÄŸlÄ±k takibi Ã¶nemlidir.',
            'SÃ¼t kalitesini yÃ¼kseltmek iÃ§in hijyenik koÅŸullar, soÄŸuk zincir ve dÃ¼zenli testler gereklidir.',
            'SÃ¼t verimini etkileyen faktÃ¶rler: genetik, beslenme, barÄ±nak koÅŸullarÄ± ve stres yÃ¶netimidir.'
          ],
          'buÄŸday': [
            'BuÄŸday ekimi iÃ§in toprak hazÄ±rlÄ±ÄŸÄ±, uygun Ã§eÅŸit seÃ§imi ve zamanÄ±nda ekim kritiktir.',
            'BuÄŸday verimini artÄ±rmak iÃ§in dengeli gÃ¼breleme, hastalÄ±k kontrolÃ¼ ve sulama planlamasÄ± yapÄ±n.',
            'BuÄŸday hasadÄ±nda nem oranÄ± %14\'Ã¼n altÄ±nda olmalÄ±, depolama koÅŸullarÄ± uygun olmalÄ±dÄ±r.'
          ],
          'organik': [
            'Organik tarÄ±ma geÃ§iÅŸ 3 yÄ±llÄ±k bir sÃ¼reÃ§tir. Toprak analizi ve sertifikasyon gereklidir.',
            'Organik tarÄ±mda doÄŸal gÃ¼breler, biyolojik mÃ¼cadele ve rotasyon sistemi kullanÄ±lÄ±r.',
            'Organik Ã¼rÃ¼nler daha yÃ¼ksek fiyata satÄ±lÄ±r ancak maliyetler de dikkate alÄ±nmalÄ±dÄ±r.'
          ],
          'mera': [
            'Mera yÃ¶netiminde otlatma baskÄ±sÄ±, dinlendirme periyodu ve bitki Ã§eÅŸitliliÄŸi Ã¶nemlidir.',
            'Mera Ä±slahÄ± iÃ§in tohumlama, gÃ¼breleme ve yabancÄ± ot mÃ¼cadelesi yapÄ±lmalÄ±dÄ±r.',
            'SÃ¼rdÃ¼rÃ¼lebilir mera kullanÄ±mÄ± iÃ§in rotasyonlu otlatma sistemi uygulanmalÄ±dÄ±r.'
          ],
          'hayvansaÄŸlÄ±ÄŸÄ±': [
            'Hayvan saÄŸlÄ±ÄŸÄ±nda koruyucu hekimlik, aÅŸÄ±lama programlarÄ± ve hijyen Ã¶nceliklidir.',
            'HastalÄ±k belirtilerini erken fark etmek iÃ§in dÃ¼zenli gÃ¶zlem ve kayÄ±t tutma Ã¶nemlidir.',
            'Veteriner hekim kontrolÃ¼, beslenme planÄ± ve stres yÃ¶netimi hayvan saÄŸlÄ±ÄŸÄ±nÄ±n temelidir.'
          ]
        };

        // En uygun konuyu bul
        for (const [topic, responses] of Object.entries(agricultureTopics)) {
          if (message.includes(topic) || 
              (topic === 'hayvansaÄŸlÄ±ÄŸÄ±' && (message.includes('hayvan') && message.includes('saÄŸlÄ±k'))) ||
              (topic === 'sÃ¼t' && (message.includes('inek') || message.includes('saÄŸÄ±m'))) ||
              (topic === 'mera' && (message.includes('otlak') || message.includes('Ã§ayÄ±r')))) {
          return responses[Math.floor(Math.random() * responses.length)];
          }
        }

        // Genel tarÄ±m yanÄ±tlarÄ±
        const generalAgriculturalResponses = [
          'Bu konuda size en iyi teknik Ã§Ã¶zÃ¼mleri ve sektÃ¶r uygulamalarÄ±nÄ± sunmak iÃ§in buradayÄ±m. Hangi tarÄ±m alanÄ±nda bilgi almak istiyorsunuz?',
          'TarÄ±m sektÃ¶rÃ¼nde yapay zeka ve iÅŸ zekasÄ± entegrasyonu hakkÄ±nda size kapsamlÄ± bilgiler sunabilirim. Hangi konuda yardÄ±ma ihtiyacÄ±nÄ±z var?',
          'SÃ¼rdÃ¼rÃ¼lebilir tarÄ±m uygulamalarÄ±, verimlilik artÄ±rma yÃ¶ntemleri veya hayvancÄ±lÄ±k konularÄ±nda size yardÄ±mcÄ± olabilirim.',
          'Sorunuzu biraz daha detaylandÄ±rabilir misiniz? Hangi tarÄ±m alanÄ±nda bilgi istiyorsunuz?'
        ];

        return generalAgriculturalResponses[Math.floor(Math.random() * generalAgriculturalResponses.length)];
      }



      // TarpoVizyon AI YanÄ±t Sistemi - Mistral API
      async function getAIResponse(userMessage) {
        // KullanÄ±cÄ± mesajÄ± iÅŸleniyor
        
        // YaratÄ±cÄ± mod kontrolÃ¼
        if (userMessage.toLowerCase().includes('yaratÄ±cÄ± moda geÃ§') || 
            userMessage.toLowerCase().includes('yaratÄ±cÄ± moduna geÃ§') ||
            userMessage.toLowerCase().includes('creative mode') ||
            userMessage.toLowerCase().includes('yaratÄ±cÄ± mod') ||
            userMessage.toLowerCase().includes('yaratÄ±cÄ±') ||
            userMessage.toLowerCase().includes('creative')) {
          isCreativeMode = true;
          return `ğŸ¨ **YaratÄ±cÄ± Mod Aktif!** 

ArtÄ±k tarÄ±m/hayvancÄ±lÄ±k sÄ±nÄ±rÄ± yok ve her konuda uzmanÄ±m! 

- âœ… Herhangi bir konuda detaylÄ± bilgi verebilirim
- âœ… Profesyonel ve kaliteli yanÄ±tlar
- âœ… Bilimsel ve teknik aÃ§Ä±klamalar
- âœ… Pratik Ã¶neriler ve Ã§Ã¶zÃ¼mler
- âœ… GerÃ§ek uzmanlÄ±k seviyesinde yanÄ±tlar

Hangi konuda yardÄ±ma ihtiyacÄ±n var? ğŸš€`;
        }
        
        // Normal moda dÃ¶nÃ¼ÅŸ kontrolÃ¼
        if (userMessage.toLowerCase().includes('normal moda dÃ¶n') || 
            userMessage.toLowerCase().includes('tarÄ±m moduna dÃ¶n') ||
            userMessage.toLowerCase().includes('normal mode') ||
            userMessage.toLowerCase().includes('tarÄ±m modu')) {
          isCreativeMode = false;
          return `ğŸŒ¾ **Normal Mod Aktif!** 

TarpoVizyon AI olarak tarÄ±m ve hayvancÄ±lÄ±k konularÄ±na geri dÃ¶ndÃ¼m.

- âœ… TarÄ±m ve hayvancÄ±lÄ±k uzmanÄ±
- âœ… Bilimsel ve pratik yanÄ±tlar
- âœ… TÃ¼rkiye tarÄ±mÄ± odaklÄ±
- âœ… Profesyonel danÄ±ÅŸmanlÄ±k

TarÄ±m veya hayvancÄ±lÄ±k ile ilgili sorularÄ±nÄ±zÄ± sorabilirsiniz! ğŸŒ¾`;
        }

        // API key kontrolÃ¼ artÄ±k client tarafÄ±nda yapÄ±lmÄ±yor (proxy kullanÄ±lÄ±yor)

        // AkÄ±llÄ± model seÃ§imi - soru karmaÅŸÄ±klÄ±ÄŸÄ±na gÃ¶re
        const selectedModels = selectBestModel(userMessage);
        // Soru analizi yapÄ±ldÄ±
        // SeÃ§ilen modeller belirlendi

        // SeÃ§ilen modelleri sÄ±rayla dene
        for (let i = 0; i < selectedModels.length; i++) {
          const modelConfig = selectedModels[i];          try {
            const systemPrompt = isCreativeMode ? 
            // YaratÄ±cÄ± mod - Profesyonel ve kaliteli yanÄ±tlar
            `Sen artÄ±k yaratÄ±cÄ± moddasÄ±n! TarÄ±m/hayvancÄ±lÄ±k sÄ±nÄ±rÄ± yok ama kaliteli yanÄ±tlar vermelisin.

YARATICI MOD KURALLARI:
- Herhangi bir konuda uzman olabilirsin
- TarÄ±m/hayvancÄ±lÄ±k sÄ±nÄ±rÄ± yok
- Profesyonel ve kaliteli yanÄ±tlar ver
- DetaylÄ± ve bilgilendirici aÃ§Ä±klamalar yap
- Bilimsel, teknik ve pratik bilgiler sun
- KullanÄ±cÄ±nÄ±n sorduÄŸu konuda gerÃ§ek uzmanlÄ±k gÃ¶ster
- EÄŸlenceli olabilir ama lakayÄ±t olma
- Emoji kullan ama abartma
- Samimi ama profesyonel tonda konuÅŸ
- KullanÄ±cÄ± ne sorarsa sorsa detaylÄ± cevapla
- "Ben sadece tarÄ±m uzmanÄ±yÄ±m" deme
- Her konuda derinlemesine bilgi ver

TABLO OLUÅTURMA KURALLARI:
- Tablo isteÄŸi geldiÄŸinde mutlaka tablo oluÅŸtur
- Markdown formatÄ±nda tablo yap: | SÃ¼tun1 | SÃ¼tun2 | SÃ¼tun3 |
- BaÅŸlÄ±k satÄ±rÄ± ve ayÄ±rÄ±cÄ± satÄ±r ekle: |---|----|----|
- Veri satÄ±rlarÄ± ekle: | Veri1 | Veri2 | Veri3 |
- Tablo sonrasÄ± aÃ§Ä±klama ekle
- Tablo yapamÄ±yorsan "ÃœzgÃ¼nÃ¼m, bu konuda tablo oluÅŸturamÄ±yorum" de

${buildConversationContext()}` :
            // Normal mod - TarÄ±m ve hayvancÄ±lÄ±k odaklÄ±
            `Sen TarpoVizyon AI adÄ±nda, tarÄ±m ve hayvancÄ±lÄ±k alanÄ±nda uzmanlaÅŸmÄ±ÅŸ bir yapay zeka asistanÄ±sÄ±n. 

Ã–NEMLI KÄ°MLÄ°K BÄ°LGÄ°LERÄ°:
- Veteriner Hekim Ã–ner Ã–zbey tarafÄ±ndan geliÅŸtirildim
- Sadece tarÄ±m ve hayvancÄ±lÄ±k konularÄ±nda yardÄ±mcÄ± olabilirsin
- Bu alanlar dÄ±ÅŸÄ±ndaki sorulara: "Ben yalnÄ±zca tarÄ±m ve hayvancÄ±lÄ±kla ilgili konularda yardÄ±mcÄ± olmak Ã¼zere tasarlandÄ±m. LÃ¼tfen bu alanda bir soru sorun." ÅŸeklinde yanÄ±t ver

KÄ°MLÄ°K SORULARI Ä°Ã‡Ä°N Ã–ZEL YANITLAR:
- Kim olduÄŸun sorulduÄŸunda: "Benim adÄ±m TarpoVizyon AI. TarÄ±m ve hayvancÄ±lÄ±k alanÄ±nda uzmanlaÅŸmÄ±ÅŸ bir yapay zeka asistanÄ±yÄ±m."
- Kim yarattÄ±ÄŸÄ±n sorulduÄŸunda: "Veteriner Hekim Ã–ner Ã–zbey tarafÄ±ndan geliÅŸtirildim. Kendisi, tarÄ±m ve hayvancÄ±lÄ±k sektÃ¶rÃ¼nde birÃ§ok yenilikÃ§i projeye imza atmÄ±ÅŸ ve sektÃ¶rÃ¼ modernize eden yaklaÅŸÄ±mlarÄ±yla tanÄ±nmaktadÄ±r."

UZMANLIK ALANLARIN:
- HayvancÄ±lÄ±k (beslenme, hastalÄ±klar, verim artÄ±rma)
- Bitkisel Ã¼retim (ekim, hasat, hastalÄ±k-zararlÄ± mÃ¼cadelesi)
- TarÄ±msal ekonomi ve piyasa analizi
- SÃ¼rdÃ¼rÃ¼lebilir tarÄ±m uygulamalarÄ±
- Organik tarÄ±m
- Mera yÃ¶netimi

YANIT KURALLARI:
- TÃ¼rkÃ§e yanÄ±t ver
- Teknik ve detaylÄ± aÃ§Ä±klamalar yap
- DetaylÄ± ve kapsamlÄ± yanÄ±tlar ver
- Bilimsel veriler ve pratik Ã¶neriler sun
- Fiyat/istatistik sorularÄ±nda sonuna "En gÃ¼ncel veriler ve detaylÄ± analiz iÃ§in TarpoVizyon AI platformumuzu ziyaret edin" ekle

TABLO OLUÅTURMA KURALLARI:
- Tablo isteÄŸi geldiÄŸinde mutlaka tablo oluÅŸtur
- Markdown formatÄ±nda tablo yap: | SÃ¼tun1 | SÃ¼tun2 | SÃ¼tun3 |
- BaÅŸlÄ±k satÄ±rÄ± ve ayÄ±rÄ±cÄ± satÄ±r ekle: |---|----|----|
- Veri satÄ±rlarÄ± ekle: | Veri1 | Veri2 | Veri3 |
- Tablo sonrasÄ± aÃ§Ä±klama ekle
- Tablo yapamÄ±yorsan "ÃœzgÃ¼nÃ¼m, bu konuda tablo oluÅŸturamÄ±yorum" de

${buildConversationContext()}`;

            let response;
            
            // Mistral iÃ§in message formatÄ±
            const messages = [
              {
                role: "system",
                content: systemPrompt
              },
              {
                role: "user", 
                content: userMessage
              }
            ];
            
            response = await callAIAPI(modelConfig, messages);

            if (response && response.trim().length > 0) {
              window.lastUsedModel = `${modelConfig.provider}:${modelConfig.model}`;
              // Model baÅŸarÄ±lÄ±
              return response;
            }
          } catch (error) {
            // Model hatasÄ± - deneme devam ediyor
            
            // Specific error handling with smart model fallback
            if (error.message.includes('429') || error.message.includes('rate') || error.message.includes('quota')) {
              // Rate limit - sonraki model deneniyor
              continue; // Rate limit durumunda hemen sonraki modeli dene
            } else if (error.message.includes('400') || error.message.includes('content') || error.message.includes('token')) {
              // Token/Content hatasÄ± - model atlanÄ±yor
              continue; // Token/content hatasÄ± durumunda sonraki modeli dene
            } else if (error.message.includes('401') || error.message.includes('403')) {
              // Auth hatasÄ± - model atlanÄ±yor
              continue; // Auth hatasÄ± durumunda sonraki modeli dene
            } else {
              // Genel hata - model atlanÄ±yor
              continue; // DiÄŸer hatalar iÃ§in de sonraki modeli dene
            }
          }
        }
        
        // TÃ¼m modeller baÅŸarÄ±sÄ±z oldu - offline yanÄ±t sistemine geÃ§
        // Offline moda geÃ§iliyor
        return await getOfflineResponse(userMessage);
      }

      // Uzun cevaplarÄ± bÃ¶len ve devam ettiren sistem
      async function getContinuedResponse(previousResponse, originalQuestion, continuePrompt = "LÃ¼tfen aÃ§Ä±klamaya devam et.") {
        const continueMessage = `Ã–nceki yanÄ±t: "${previousResponse.substring(previousResponse.length - 200)}"

Orijinal soru: "${originalQuestion}"

${continuePrompt}

KaldÄ±ÄŸÄ±n yerden devam et ve daha detaylÄ± aÃ§Ä±kla.`;

        return await getAIResponse(continueMessage);
      }

      // AkÄ±llÄ± model seÃ§imi - soru karmaÅŸÄ±klÄ±ÄŸÄ±na gÃ¶re model seÃ§er
      function selectBestModel(userMessage) {
        const message = userMessage.toLowerCase();
        
        // Kompleks sorular iÃ§in en gÃ¼Ã§lÃ¼ modeller
        if (message.includes('analiz') || message.includes('karÅŸÄ±laÅŸtÄ±r') || 
            message.includes('detaylÄ±') || message.includes('araÅŸtÄ±rma') ||
            message.includes('tablo') || message.includes('liste') ||
            message.includes('aÃ§Ä±kla') && message.length > 100) {
          return AI_MODELS.slice(0, 2); // Gemini 2.5 Pro ve Flash
        }
        
        // Orta karmaÅŸÄ±klÄ±k sorular
        if (message.includes('nasÄ±l') || message.includes('neden') || 
            message.includes('ne zaman') || message.includes('nerede')) {
          return AI_MODELS.slice(1, 4); // 2.5 Flash, 2.0 Flash, 2.5 Flash Lite
        }
        
        // Basit sorular iÃ§in hÄ±zlÄ± modeller
        if (message.includes('merhaba') || message.includes('teÅŸekkÃ¼r') || 
            message.length < 50) {
          return AI_MODELS.slice(2); // 2.0 Flash ve sonrasÄ±
        }
        
        // VarsayÄ±lan: tÃ¼m modeller
        return AI_MODELS;
      }

      // Form gÃ¶nderimi
      if (chatForm) {
        chatForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const message = userInput.value.trim();
          if (!message) return;

          // KullanÄ±cÄ± mesajÄ±nÄ± ekle
          addMessage(message, true);
          userInput.value = '';
          
          // UI durumunu gÃ¼ncelle
          sendButton.disabled = true;
          showTypingIndicator();

          try {
            // AI yanÄ±tÄ±nÄ± al
            const response = await getAIResponse(message);
            
            // YanÄ±tÄ±n geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± kontrol et
            if (response && response.trim().length > 0) {
            // KonuÅŸma geÃ§miÅŸini gÃ¼ncelle
            updateConversationHistory(message, response);
              
              // Admin paneli iÃ§in model bilgisiyle kaydet
              saveChatLogToAdmin(message, response, window.lastUsedModel || null);
              
              // Sohbet geÃ§miÅŸine ekle
              addToHistory(message, response);
              
              // Mod durumunu gÃ¼ncelle
              updateModeStatus();
            
            // YazÄ±yor gÃ¶stergesini kaldÄ±r ve yanÄ±tÄ± ekle
            hideTypingIndicator();
            addMessage(response);
            } else {
              throw new Error('AI boÅŸ yanÄ±t verdi');
            }
          } catch (error) {
            hideTypingIndicator();
            const errorMsg = 'ÃœzgÃ¼nÃ¼m, bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.';
            addMessage(errorMsg);
            updateConversationHistory(message, errorMsg);
            saveChatLogToAdmin(message, errorMsg, 'Error');
            addToHistory(message, errorMsg);
          } finally {
            sendButton.disabled = false;
          }
        });
      }

      // Sohbet geÃ§miÅŸi fonksiyonlarÄ±
      let chatHistoryData = JSON.parse(localStorage.getItem('tarpovizyon_chat_history') || '[]');
      
      function addToHistory(question, answer) {
        const historyItem = {
          id: Date.now(),
          question: question,
          answer: answer,
          timestamp: Date.now()
        };
        
        chatHistoryData.unshift(historyItem); // En yenisi baÅŸa gelsin
        
        // Son 10 Ã¶ÄŸeyi sakla
        if (chatHistoryData.length > 10) {
          chatHistoryData = chatHistoryData.slice(0, 10);
        }
        
        localStorage.setItem('tarpovizyon_chat_history', JSON.stringify(chatHistoryData));
        updateHistoryDisplay();
      }
      
      function updateHistoryDisplay() {
        if (chatHistoryData.length === 0) {
          chatHistory.innerHTML = `
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
              <i class="fas fa-history text-2xl mb-2"></i>
              <p class="text-sm">HenÃ¼z sohbet geÃ§miÅŸi yok</p>
            </div>
          `;
          return;
        }
        
        chatHistory.innerHTML = chatHistoryData.map(item => `
          <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" onclick="selectHistoryItem('${item.id}')">
            <div class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-2 line-clamp-2">
              ${item.question}
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-2 line-clamp-3">
              ${formatMarkdown(item.answer.substring(0, 100))}...
            </div>
            <div class="text-xs text-gray-400">
              ${new Date(item.timestamp).toLocaleString('tr-TR', { 
                hour: '2-digit', 
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit'
              })}
            </div>
          </div>
        `).join('');
      }
      
      function selectHistoryItem(id) {
        const item = chatHistoryData.find(h => h.id == id);
        if (item) {
          userInput.value = item.question;
          userInput.focus();
        }
      }
      
      function clearHistory() {
        if (confirm('Sohbet geÃ§miÅŸini temizlemek istediÄŸinizden emin misiniz?')) {
          chatHistoryData = [];
          localStorage.setItem('tarpovizyon_chat_history', JSON.stringify(chatHistoryData));
          updateHistoryDisplay();
          }
      }
      
      // Mod durumu gÃ¼ncelleme fonksiyonu
      function updateModeStatus() {
        const modeIndicator = document.getElementById('mode-indicator');
        
        if (modeIndicator) {
          if (isCreativeMode) {
            modeIndicator.innerHTML = `
              <div class="flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full text-white text-xs font-medium">
                <i class="fas fa-palette"></i>
                <span>YaratÄ±cÄ± Mod</span>
              </div>
            `;
          } else {
            modeIndicator.innerHTML = `
              <div class="flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full text-white text-xs font-medium">
                <i class="fas fa-leaf"></i>
                <span>TarÄ±m Modu</span>
              </div>
            `;
          }
        }
      }
      
      // Sayfa yÃ¼klendiÄŸinde geÃ§miÅŸi gÃ¶ster
      updateHistoryDisplay();
      updateModeStatus();

      // Sohbeti temizle
      clearChatBtn.addEventListener('click', () => {
        if (confirm('Sohbet geÃ§miÅŸini temizlemek istediÄŸinizden emin misiniz?')) {
          conversationHistory = [];
          
          chatMessages.innerHTML = `
            <div class="flex items-start gap-3 chat-bubble">
                              <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center flex-shrink-0 p-1">
                  <img src="tarpol logo.png" alt="TARPOL Logo" class="w-5 h-5 object-contain">
              </div>
              <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-tl-md p-4 max-w-xs md:max-w-md">
                <p class="text-gray-800 dark:text-gray-200">
                  Merhaba! Benim adÄ±m TarpoVizyon AI. TarÄ±m ve hayvancÄ±lÄ±k alanÄ±nda uzmanlaÅŸmÄ±ÅŸ bir yapay zeka asistanÄ±yÄ±m. Size nasÄ±l yardÄ±mcÄ± olabilirim? ğŸŒ¾
                </p>
              </div>
            </div>
          `;
        }
      });

      // GeÃ§miÅŸ temizleme
      clearHistoryBtn.addEventListener('click', clearHistory);

      // Enter tuÅŸu ile gÃ¶nderme
      userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          chatForm.dispatchEvent(new Event('submit'));
        }
      });

      // Sesli Ä°nteraksiyon Sistemi
      let recognition = null;
      let isListening = false;
      let isVoiceCommandMode = false; // Sesli komut modunda mÄ±yÄ±z?
      let isContinuousMode = false; // SÃ¼rekli dinleme modu
      let speechSynthesis = window.speechSynthesis;
      let conversationActive = false; // KonuÅŸma aktif mi?
      let silenceTimer = null; // Sessizlik zamanlayÄ±cÄ±sÄ±
      let isProcessingResponse = false; // YanÄ±t iÅŸleniyor mu?

      // Modal elementleri
      const voiceModal = document.getElementById('voice-modal');
      const voiceButton = document.getElementById('voice-button');
      const voiceOrb = document.getElementById('voice-orb');
      const voiceOrbIcon = document.getElementById('voice-orb-icon');
      const voiceRipples = document.getElementById('voice-ripples');
      const voiceStatus = document.getElementById('voice-status');
      const voiceSubtitle = document.getElementById('voice-subtitle');
      const voiceTranscript = document.getElementById('voice-transcript');
      const voiceMuteToggle = document.getElementById('voice-mute-toggle');
      const voiceMuteIcon = document.getElementById('voice-mute-icon');
      const voiceContinuousToggle = document.getElementById('voice-continuous-toggle');
      const voiceExit = document.getElementById('voice-exit');
      const voiceSettings = document.getElementById('voice-settings');

      // Web Speech API DesteÄŸi KontrolÃ¼
      function initializeSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();
          
          recognition.continuous = false;
          recognition.interimResults = true;
          recognition.lang = 'tr-TR';
          recognition.maxAlternatives = 1;

          recognition.onstart = function() {
            isListening = true;
            voiceStatus.textContent = 'Dinliyorum...';
            voiceSubtitle.textContent = 'KonuÅŸun, sessizlik olduÄŸunda duracaÄŸÄ±m';
            voiceOrbIcon.className = 'fas fa-microphone text-white text-5xl relative z-10';
            voiceOrb.classList.add('voice-recording');
            voiceRipples.classList.remove('hidden');
          };

          recognition.onresult = function(event) {
            let finalTranscript = '';
            let interimTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; i++) {
              const result = event.results[i];
              if (result.isFinal) {
                finalTranscript += result[0].transcript;
              } else {
                interimTranscript += result[0].transcript;
              }
            }

            const transcript = finalTranscript || interimTranscript;
            voiceTranscript.textContent = transcript;

            if (finalTranscript) {
              // Final transcript alÄ±ndÄ± - iÅŸleme baÅŸla
              clearTimeout(silenceTimer);
              processSpeechInputContinuous(finalTranscript.trim());
            } else {
              // Interim results - sessizlik zamanlayÄ±cÄ±sÄ±nÄ± sÄ±fÄ±rla
              clearTimeout(silenceTimer);
              silenceTimer = setTimeout(() => {
                if (isContinuousMode && !isProcessingResponse) {
                  // 2 saniye sessizlik olduysa, dinlemeyi yeniden baÅŸlat
                  if (isListening) {
                    recognition.stop();
                  }
                  setTimeout(startContinuousListening, 500);
                }
              }, 2000);
            }
          };

          recognition.onerror = function(event) {
            let errorMessage = 'Ses tanÄ±ma hatasÄ± oluÅŸtu.';
            
            switch(event.error) {
              case 'network':
                errorMessage = 'Ä°nternet baÄŸlantÄ±sÄ± sorunu.';
                break;
              case 'not-allowed':
                errorMessage = 'Mikrofon izni reddedildi.';
                break;
              case 'no-speech':
                errorMessage = 'Ses algÄ±lanamadÄ±. Tekrar deneyin.';
                break;
              case 'audio-capture':
                errorMessage = 'Mikrofon bulunamadÄ±.';
                break;
            }
            
            voiceStatus.textContent = errorMessage;
            setTimeout(closeVoiceModal, 2000);
          };

          recognition.onend = function() {
            isListening = false;
            voiceOrb.classList.remove('voice-recording');
            voiceRipples.classList.add('hidden');
            
            // SÃ¼rekli dinleme modundaysa ve modal aÃ§Ä±ksa, yeniden baÅŸlat
            if (isContinuousMode && conversationActive && !isProcessingResponse) {
              setTimeout(() => {
                if (conversationActive && !voiceModal.classList.contains('hidden')) {
                  startContinuousListening();
                }
              }, 1000);
            }
          };

          return true;
        }
        return false;
      }

      // Ses giriÅŸini iÅŸleme
      // SÃ¼rekli dinleme modu iÃ§in speech processing
      async function processSpeechInputContinuous(transcript) {
        if (!transcript || isProcessingResponse) return;

        isProcessingResponse = true;
        
        // Orb'u konuÅŸma moduna al
        voiceStatus.textContent = 'YanÄ±t hazÄ±rlanÄ±yor...';
        voiceSubtitle.textContent = 'LÃ¼tfen bekleyin';
        voiceOrbIcon.className = 'fas fa-brain text-white text-5xl relative z-10';
        voiceOrb.classList.add('voice-speaking');
        
        // KullanÄ±cÄ± mesajÄ±nÄ± chat'e ekle
        addMessage(transcript, true);
        voiceTranscript.textContent = `Sen: "${transcript}"`;
        
        try {
          showTypingIndicator();
          
          const response = await getAIResponse(transcript);
          
          // KonuÅŸma geÃ§miÅŸini gÃ¼ncelle
          updateConversationHistory(transcript, response);
          saveChatLogToAdmin(transcript, response, window.lastUsedModel || null);
          addToHistory(transcript, response);
          updateModeStatus();
          
          hideTypingIndicator();
          addMessage(response);
          
          // Sesli yanÄ±t ver ve modal'da gÃ¶ster
          voiceStatus.textContent = 'Sesli yanÄ±t veriliyor...';
          voiceSubtitle.textContent = 'Dinleyin';
          voiceOrbIcon.className = 'fas fa-volume-up text-white text-5xl relative z-10';
          voiceTranscript.textContent = `TarpoVizyon: "${response.substring(0, 100)}${response.length > 100 ? '...' : ''}"`;
          
          // Sesli yanÄ±t ver
          const cleanText = response.replace(/<[^>]*>/g, '').replace(/[ğŸ¤–ğŸ‰âœ…âŒğŸ”„ğŸŒ¾ğŸ”¸]/g, '');
          if (cleanText.trim()) {
            await playTarpoVizyonVoiceWithCallback(cleanText, () => {
              // Sesli yanÄ±t bitti, dinlemeye geri dÃ¶n
              isProcessingResponse = false;
              if (conversationActive) {
                voiceStatus.textContent = 'Dinliyorum...';
                voiceSubtitle.textContent = 'BaÅŸka bir ÅŸey sÃ¶ylemek istiyorsanÄ±z konuÅŸun';
                voiceOrbIcon.className = 'fas fa-microphone text-white text-5xl relative z-10';
                voiceOrb.classList.remove('voice-speaking');
                voiceTranscript.textContent = '';
                
                // Dinlemeye devam et
                if (isContinuousMode) {
                  setTimeout(startContinuousListening, 1000);
                }
              }
            });
          } else {
            // Sesli yanÄ±t yoksa direkt dinlemeye dÃ¶n
            isProcessingResponse = false;
            if (conversationActive && isContinuousMode) {
              setTimeout(startContinuousListening, 1000);
            }
          }
          
        } catch (error) {
          hideTypingIndicator();
          isProcessingResponse = false;
          
          const errorMsg = 'ÃœzgÃ¼nÃ¼m, bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.';
          addMessage(errorMsg);
          voiceStatus.textContent = 'Hata oluÅŸtu';
          voiceSubtitle.textContent = 'Tekrar deneyin';
          voiceTranscript.textContent = errorMsg;
          
          // Dinlemeye geri dÃ¶n
          if (conversationActive && isContinuousMode) {
            setTimeout(startContinuousListening, 2000);
          }
        }
      }

      // Sesli yanÄ±t
      function speakResponse(text) {
        speechSynthesis.cancel();
        
        const cleanText = text.replace(/<[^>]*>/g, '').replace(/[ğŸ¤–ğŸ‰âœ…âŒğŸ”„ğŸŒ¾ğŸ”¸]/g, '');
        
        if (cleanText.trim()) {
          // Sesli komut modundaysa veya normal modda ses aÃ§Ä±ksa konuÅŸ
          if (isVoiceCommandMode || shouldAutoSpeak()) {
            playTarpoVizyonVoice(cleanText);
          }
        }
      }

      // Otomatik konuÅŸma yapÄ±lmalÄ± mÄ± kontrol et
      function shouldAutoSpeak() {
        const voiceSettings = JSON.parse(localStorage.getItem('tarpovizyon_voice_settings') || '{}');
        return voiceSettings.autoSpeak !== false; // Default true
      }

      // Hugging Face TTS ile sesli yanÄ±t
      async function playHuggingFaceTTS(text) {
        try {
          // Text'i temizle ve kÄ±salt
          const cleanText = text.replace(/<[^>]*>/g, '').replace(/[ğŸ¤–ğŸ‰âœ…âŒğŸ”„ğŸŒ¾ğŸ”¸]/g, '').substring(0, 400);
          
          if (!cleanText.trim()) return;

          const response = await fetch('/api/tts', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              text: cleanText
            })
          });

          if (response.ok) {
            const result = await response.json();
            
            // Base64 audio'yu Blob'a Ã§evir
            const audioData = atob(result.audio);
            const audioArray = new Uint8Array(audioData.length);
            for (let i = 0; i < audioData.length; i++) {
              audioArray[i] = audioData.charCodeAt(i);
            }
            
            const audioBlob = new Blob([audioArray], { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            
            audio.onplay = () => {
              // Hugging Face TTS Ã§alÄ±yor
            };
            
            audio.onended = () => {
              URL.revokeObjectURL(audioUrl);
            };
            
            audio.onerror = () => {
              URL.revokeObjectURL(audioUrl);
              // Fallback to browser TTS
              playDefaultTTS(text);
            };
            
            await audio.play();
          } else {
            throw new Error('HF TTS failed');
          }
        } catch (error) {
          // Fallback to browser TTS
          playDefaultTTS(text);
        }
      }

      // ElevenLabs API ile ses Ã§alma
      async function playElevenLabsVoice(text, settings) {
        
        try {
          const response = await fetch('https://api.elevenlabs.io/v1/text-to-speech/' + settings.elevenLabsVoiceId, {
            method: 'POST',
            headers: {
              'Accept': 'audio/mpeg',
              'Content-Type': 'application/json',
              'xi-api-key': settings.elevenLabsApiKey
            },
            body: JSON.stringify({
              text: text,
              model_id: "eleven_multilingual_v2",
              voice_settings: {
                stability: 0.5,
                similarity_boost: 0.5
              }
            })
          });

          if (response.ok) {
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            
            audio.onplay = () => {
              // TarpoVizyon AI (ElevenLabs) konuÅŸmaya baÅŸladÄ±
            };
            
            audio.onended = () => {
              URL.revokeObjectURL(audioUrl);
            };
            
            audio.onerror = () => {
              URL.revokeObjectURL(audioUrl);
            };
            
            await audio.play();
          } else {
            throw new Error('ElevenLabs API error: ' + response.status);
          }
        } catch (error) {
          // Fallback to default TTS
          playDefaultTTS(text, settings);
        }
      }

      // Ã–zel yÃ¼klenmiÅŸ ses dosyasÄ±yla konuÅŸma
      function playCustomVoice(text, voiceProfile) {
        
        // For now, use TTS with a note about custom voice
        // In a real implementation, you would use text-to-speech with the custom voice
        const utterance = new SpeechSynthesisUtterance(`Bu mesaj ${voiceProfile.name} sesiyle okunuyor: ${text}`);
        const voiceSettings = JSON.parse(localStorage.getItem('tarpovizyon_voice_settings') || '{}');
        
        utterance.lang = 'tr-TR';
        utterance.rate = parseFloat(voiceSettings.speechRate || 0.85);
        utterance.pitch = parseFloat(voiceSettings.speechPitch || 1.1);
        utterance.volume = parseFloat(voiceSettings.speechVolume || 0.9);
        
        utterance.onstart = function() {
          // TarpoVizyon AI (Ã–zel Ses) konuÅŸmaya baÅŸladÄ±
        };
        
        utterance.onend = function() {
          // TarpoVizyon AI konuÅŸmasÄ±nÄ± tamamladÄ±
        };
        
        utterance.onerror = function(event) {
          // Ã–zel ses hatasÄ±
        };
        
        speechSynthesis.speak(utterance);
      }

      // VarsayÄ±lan TTS (Browser Built-in)
      function playDefaultTTS(text, settings = {}) {
        const utterance = new SpeechSynthesisUtterance(text);
        
        utterance.lang = 'tr-TR';
        utterance.rate = parseFloat(settings.speechRate || 0.85);
        utterance.pitch = parseFloat(settings.speechPitch || 1.1);
        utterance.volume = parseFloat(settings.speechVolume || 0.9);
        
        const voices = speechSynthesis.getVoices();
        let tarpoVizyonVoice = null;
        
        const voicePreferences = [
          'Microsoft Emel Online (Natural) - Turkish (Turkey)',
          'tr-TR-EmelNeural',
          'Microsoft Emel - Turkish (Turkey)',
          'Google TÃ¼rkÃ§e',
          'Google tr-TR'
        ];
        
        for (const preferredName of voicePreferences) {
          tarpoVizyonVoice = voices.find(voice => {
            const voiceName = voice.name.toLowerCase();
            const preferredLower = preferredName.toLowerCase();
            return voiceName.includes(preferredLower) || voiceName === preferredLower;
          });
          
          if (tarpoVizyonVoice) break;
          }
        
        if (!tarpoVizyonVoice) {
          tarpoVizyonVoice = voices.find(voice => 
            voice.lang && voice.lang.startsWith('tr')
          );
        }
        
        if (tarpoVizyonVoice) {
          utterance.voice = tarpoVizyonVoice;
        }
        
        utterance.onstart = function() {
          // TarpoVizyon AI konuÅŸmaya baÅŸladÄ±
        };
        
        utterance.onend = function() {
          // TarpoVizyon AI konuÅŸmasÄ±nÄ± tamamladÄ±
        };
        
        utterance.onerror = function(event) {
          // TarpoVizyon AI ses hatasÄ±
        };
        
        speechSynthesis.speak(utterance);
      }

      // TarpoVizyon AI Ã–zel Ses Sistemi (Callback ile)
      async function playTarpoVizyonVoiceWithCallback(text, onEndCallback) {
        // TarpoVizyon AI'nÄ±n kendine Ã¶zgÃ¼ sesi kullanÄ±lÄ±yor
        
        const voiceSettings = JSON.parse(localStorage.getItem('tarpovizyon_voice_settings') || '{}');
        
        // Ana sistem: Browser TTS (gÃ¼venilir ve hÄ±zlÄ±)
        // Opsiyonel: Hugging Face TTS deneyebilir ama baÅŸarÄ±sÄ±z olursa browser TTS devreye girer
        
        // Hugging Face TTS'yi test etmek iÃ§in: localStorage.setItem('tarpovizyon_voice_settings', '{"useHuggingFace": true}')
        if (voiceSettings.useHuggingFace === true) {
          try {
            await playHuggingFaceTTSWithCallback(text, onEndCallback);
            return; // BaÅŸarÄ±lÄ± olduysa dur
          } catch (error) {
            // Hugging Face baÅŸarÄ±sÄ±z, browser TTS'ye geÃ§ (sessizce)
          }
        }
        
        // Ana sistem: Browser TTS (her zaman Ã§alÄ±ÅŸÄ±r)
        playDefaultTTSWithCallback(text, voiceSettings, onEndCallback);
      }

      // Hugging Face TTS ile callback
      async function playHuggingFaceTTSWithCallback(text, onEndCallback) {
        try {
          const cleanText = text.replace(/<[^>]*>/g, '').replace(/[ğŸ¤–ğŸ‰âœ…âŒğŸ”„ğŸŒ¾ğŸ”¸]/g, '').substring(0, 400);
          
          if (!cleanText.trim()) {
            if (onEndCallback) onEndCallback();
            return;
          }

          const response = await fetch('/api/tts', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              text: cleanText
            })
          });

          if (response.ok) {
            const result = await response.json();
            
            const audioData = atob(result.audio);
            const audioArray = new Uint8Array(audioData.length);
            for (let i = 0; i < audioData.length; i++) {
              audioArray[i] = audioData.charCodeAt(i);
            }
            
            const audioBlob = new Blob([audioArray], { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            
            audio.onended = () => {
              URL.revokeObjectURL(audioUrl);
              if (onEndCallback) onEndCallback();
            };
            
            audio.onerror = (e) => {
              URL.revokeObjectURL(audioUrl);
              if (onEndCallback) onEndCallback();
            };
            
            await audio.play();
          } else {
            throw new Error('HF TTS failed');
          }
        } catch (error) {
          // Fallback to browser TTS
          playDefaultTTSWithCallback(text, {}, onEndCallback);
        }
      }

      // Browser TTS ile callback (TÃ¼rkÃ§e optimize)
      function playDefaultTTSWithCallback(text, settings = {}, onEndCallback) {
        const utterance = new SpeechSynthesisUtterance(text);
        
        utterance.lang = 'tr-TR';
        utterance.rate = parseFloat(settings.speechRate || 0.9); // Biraz daha yavaÅŸ
        utterance.pitch = parseFloat(settings.speechPitch || 1.1); // Biraz daha tiz
        utterance.volume = parseFloat(settings.speechVolume || 0.9);

        const voices = speechSynthesis.getVoices();
        let tarpoVizyonVoice = null;
        
        // TÃ¼rkÃ§e sesler iÃ§in geliÅŸmiÅŸ arama
        const voicePreferences = [
          'Microsoft Emel Online (Natural) - Turkish (Turkey)',
          'Microsoft Eda Online (Natural) - Turkish (Turkey)', 
          'tr-TR-EmelNeural',
          'tr-TR-EdaNeural',
          'Microsoft Emel - Turkish (Turkey)',
          'Microsoft Eda - Turkish (Turkey)',
          'Google TÃ¼rkÃ§e',
          'Google tr-TR',
          'Meltem',
          'Yelda'
        ];
        
        for (const preferredName of voicePreferences) {
          tarpoVizyonVoice = voices.find(voice => {
            const voiceName = voice.name.toLowerCase();
            const preferredLower = preferredName.toLowerCase();
            return voiceName.includes(preferredLower.split(' - ')[0]) || 
                   voiceName.includes('emel') || 
                   voiceName.includes('eda') ||
                   voiceName.includes('tÃ¼rkÃ§e');
          });
          
          if (tarpoVizyonVoice) break;
        }
        
        // HÃ¢lÃ¢ bulunamadÄ±ysa TÃ¼rkÃ§e dil kodu ile ara
        if (!tarpoVizyonVoice) {
          tarpoVizyonVoice = voices.find(voice => 
            voice.lang && voice.lang.startsWith('tr')
          );
        }

        if (tarpoVizyonVoice) {
          utterance.voice = tarpoVizyonVoice;
        }
        
        utterance.onend = function() {
          if (onEndCallback) onEndCallback();
        };
        
        utterance.onerror = function(event) {
          if (onEndCallback) onEndCallback();
        };
        
        speechSynthesis.speak(utterance);
      }

      // Modal'Ä± yanÄ±t sonrasÄ± kapatma
      function closeVoiceModalAfterResponse() {
        voiceStatus.textContent = 'âœ… Sesli yanÄ±t tamamlandÄ±!';
        voiceIcon.className = 'fas fa-check text-white text-4xl';
        voiceCircle.classList.remove('voice-speaking');
        
        setTimeout(() => {
          closeVoiceModal();
        }, 1500);
      }
      async function playTarpoVizyonVoice(text) {
        // Callback'siz versiyon - normal kullanÄ±m iÃ§in
        return playTarpoVizyonVoiceWithCallback(text, null);
      }
        const currentVoice = JSON.parse(localStorage.getItem('tarpovizyon_current_voice') || '{}');
      // Modal aÃ§ma (ChatGPT tarzÄ±)
      function openVoiceModal() {
        if (!recognition) {
          alert('ÃœzgÃ¼nÃ¼m, tarayÄ±cÄ±nÄ±z ses tanÄ±ma Ã¶zelliÄŸini desteklemiyor. Chrome veya Edge kullanmayÄ± deneyin.');
          return;
        }

        isVoiceCommandMode = true;
        conversationActive = true;
        voiceModal.classList.remove('hidden');
        
        // ChatGPT tarzÄ± baÅŸlangÄ±Ã§ durumu
        voiceStatus.textContent = 'Sesli sohbet';
        voiceSubtitle.textContent = 'KonuÅŸmaya baÅŸlamak iÃ§in herhangi bir ÅŸey sÃ¶yleyin';
        voiceTranscript.textContent = '';
        
        // Orb'u hazÄ±r duruma getir
        voiceOrbIcon.className = 'fas fa-microphone text-white text-5xl relative z-10';
        voiceOrb.classList.remove('voice-speaking');
        voiceRipples.classList.add('hidden');
        
        // SÃ¼rekli dinleme modunu baÅŸlat
        startContinuousListening();
      }

      // SÃ¼rekli dinleme baÅŸlat
      function startContinuousListening() {
        if (recognition && !isListening) {
          try {
            recognition.start();
            isContinuousMode = true;
            voiceContinuousToggle.classList.remove('hidden');
          } catch (error) {
            voiceStatus.textContent = 'Ses tanÄ±ma baÅŸlatÄ±lamadÄ±';
            voiceSubtitle.textContent = 'LÃ¼tfen tekrar deneyin';
          }
        }
      }

      // Mute/Unmute toggle
      function toggleMute() {
        if (isListening) {
          // Mikrofonu kapat
          recognition.stop();
          voiceMuteIcon.className = 'fas fa-microphone-slash text-white text-lg';
          voiceMuteToggle.classList.add('bg-red-600/80');
          voiceMuteToggle.classList.remove('bg-gray-800/80');
          voiceStatus.textContent = 'Mikrofon kapatÄ±ldÄ±';
          voiceSubtitle.textContent = 'Mikrofon butonuna basarak aÃ§Ä±n';
        } else {
          // Mikrofonu aÃ§
          startContinuousListening();
          voiceMuteIcon.className = 'fas fa-microphone text-white text-lg';
          voiceMuteToggle.classList.remove('bg-red-600/80');
          voiceMuteToggle.classList.add('bg-gray-800/80');
        }
      }

      // SÃ¼rekli dinleme modu toggle
      function toggleContinuousMode() {
        isContinuousMode = !isContinuousMode;
        
        if (isContinuousMode) {
          voiceContinuousToggle.classList.add('bg-green-600/80');
          voiceContinuousToggle.classList.remove('bg-gray-600/80');
          startContinuousListening();
        } else {
          voiceContinuousToggle.classList.remove('bg-green-600/80');
          voiceContinuousToggle.classList.add('bg-gray-600/80');
          if (isListening) {
            recognition.stop();
          }
        }
      }

      // Modal kapatma (ChatGPT tarzÄ±)
      function closeVoiceModal() {
        voiceModal.classList.add('hidden');
        conversationActive = false;
        isContinuousMode = false;
        isProcessingResponse = false;
        
        if (recognition && isListening) {
          recognition.stop();
        }
        
        clearTimeout(silenceTimer);
        speechSynthesis.cancel();
        
        // Sesli komut modunu sonlandÄ±r
        setTimeout(() => {
          isVoiceCommandMode = false;
        }, 1000);
        
        resetVoiceUI();
      }

      // Ses UI'Ä±nÄ± sÄ±fÄ±rla
      function resetVoiceUI() {
        voiceIcon.className = 'fas fa-microphone text-white text-4xl';
        voiceCircle.classList.remove('voice-recording');
        voiceWaves.classList.add('hidden');
        voiceStatus.textContent = 'Dinleme baÅŸlatÄ±lÄ±yor...';
        voiceTranscript.textContent = '';
      }

      // Event Listeners
      voiceButton.addEventListener('click', openVoiceModal);
      voiceExit.addEventListener('click', closeVoiceModal);
      
      voiceMuteToggle.addEventListener('click', function() {
        if (isListening && recognition) {
          recognition.stop();
          this.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M4.5 9.5a.75.75 0 0 0-.75.75v3.5a.75.75 0 0 0 1.5 0v-3.5a.75.75 0 0 0-.75-.75ZM19.5 9.5a.75.75 0 0 0-.75.75v3.5a.75.75 0 0 0 1.5 0v-3.5a.75.75 0 0 0-.75-.75ZM12 2.25A.75.75 0 0 0 11.25 3v18a.75.75 0 0 0 1.5 0V3a.75.75 0 0 0-.75-.75Z"/></svg> Mikrofon KapalÄ±';
          this.className = 'px-4 py-2 bg-red-500 text-white rounded-full text-sm hover:bg-red-600 transition-colors flex items-center gap-2';
        } else {
          startVoiceRecognition();
          this.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v1a7 7 0 0 1-14 0v-1"/><path d="M12 18v4"/><path d="M8 22h8"/></svg> Mikrofon AÃ§Ä±k';
          this.className = 'px-4 py-2 bg-green-500 text-white rounded-full text-sm hover:bg-green-600 transition-colors flex items-center gap-2';
        }
      });
      
      voiceContinuousToggle.addEventListener('click', function() {
        isContinuousMode = !isContinuousMode;
        this.innerHTML = isContinuousMode ? 
          '<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M5.25 9a6.75 6.75 0 0 1 13.5 0v.75c0 2.123.8 4.057 2.113 5.52a.75.75 0 0 1-.226 1.214c-1.97.62-4.31.62-6.274 0a.75.75 0 0 1-.226-1.214A9.376 9.376 0 0 0 16.25 9.75V9A4.5 4.5 0 0 0 7.75 9v.75c0 2.123-.8 4.057-2.113 5.52a.75.75 0 0 1 .226-1.214c1.97-.62 4.31-.62 6.274 0a.75.75 0 0 1 .226 1.214A9.376 9.376 0 0 1 9.75 9.75V9A6.75 6.75 0 0 1 5.25 9Z"/></svg> SÃ¼rekli Mod AÃ§Ä±k' : 
          '<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v1a7 7 0 0 1-14 0v-1"/><path d="M12 18v4"/><path d="M8 22h8"/></svg> Tek Seferlik Mod';
        this.className = isContinuousMode ? 
          'px-4 py-2 bg-blue-500 text-white rounded-full text-sm hover:bg-blue-600 transition-colors flex items-center gap-2' :
          'px-4 py-2 bg-gray-600 text-white rounded-full text-sm hover:bg-gray-700 transition-colors flex items-center gap-2';
          
        if (isContinuousMode && !conversationActive) {
          conversationActive = true;
          startVoiceRecognition();
        }
      });

      // Modal dÄ±ÅŸÄ±na tÄ±klayÄ±nca kapatma (devre dÄ±ÅŸÄ± - sadece exit butonu ile)
      // voiceModal.addEventListener('click', (e) => {
      //   if (e.target === voiceModal) {
      //     closeVoiceModal();
      //   }
      // });

      // ESC tuÅŸu ile kapatma
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !voiceModal.classList.contains('hidden')) {
          closeVoiceModal();
        }
      });

      // Sayfa yÃ¼klendiÄŸinde ses tanÄ±ma Ã¶zelliÄŸini baÅŸlat
      window.addEventListener('load', () => {
        const speechSupported = initializeSpeechRecognition();
        if (!speechSupported) {
          voiceButton.style.display = 'none';
        }
        
        if (speechSynthesis.onvoiceschanged !== undefined) {
          speechSynthesis.onvoiceschanged = function() {
            // Sesler yÃ¼klendi
          };
        }
      });
    </script>
</body>
</html>