<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TarpoVizyon AI - TarÄ±m ve HayvancÄ±lÄ±k Yapay Zeka AsistanÄ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Console uyarÄ±larÄ±nÄ± gizle
      const originalWarn = console.warn;
      const originalError = console.error;
      
      console.warn = function() {
        // Tailwind CSS uyarÄ±sÄ±nÄ± gizle
        const args = Array.from(arguments);
        const message = args.join(' ');
        if (message.includes('cdn.tailwindcss.com') || message.includes('should not be used in production')) {
          return;
        }
        originalWarn.apply(console, arguments);
      };
      
      console.error = function() {
        // API hatalarÄ±nÄ± gizle
        const args = Array.from(arguments);
        const message = args.join(' ');
        if (message.includes('generativelanguage.googleapis.com') || 
            message.includes('429') || 
            message.includes('404') ||
            message.includes('Failed to load resource') ||
            message.includes('POST') ||
            message.includes('generateContent')) {
          return;
        }
        originalError.apply(console, arguments);
      };
      
      // Network hatalarÄ±nÄ± da gizle
      const originalFetch = window.fetch;
      window.fetch = function(url, options) {
        return originalFetch.apply(this, arguments).catch(error => {
          // API hatalarÄ±nÄ± sessizce yakala
          if (url.includes('generativelanguage.googleapis.com')) {
            return new Response('', { status: 200 });
          }
          throw error;
        });
      };
    </script>
    <!-- TarpoVizyon AI Ã–zel Ses Sistemi iÃ§in Web Audio API -->
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: '#22c55e',
              secondary: '#16a34a',
              accent: '#15803d',
              dark: '#0f0f23',
              light: '#f8fafc'
            },
            fontFamily: {
              sans: ['Inter', 'ui-sans-serif', 'system-ui'],
            },
            animation: {
              'float': 'float 6s ease-in-out infinite',
              'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'typing': 'typing 1s steps(20) infinite',
            },
            keyframes: {
              float: {
                '0%, 100%': { transform: 'translateY(0px)' },
                '50%': { transform: 'translateY(-20px)' },
              },
              typing: {
                '0%': { opacity: '0.4' },
                '50%': { opacity: '1' },
                '100%': { opacity: '0.4' },
              }
            }
          },
        },
      }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
      }
      
      .gradient-text {
        background: linear-gradient(135deg, #22c55e, #16a34a, #15803d);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 200% 200%;
        animation: gradient 3s ease infinite;
      }
      
      @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      
      .ai-glow {
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
      }
      
      .chat-bubble {
        animation: slideUp 0.3s ease-out;
      }
      
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .typing-indicator {
        display: inline-block;
        animation: typing 1.5s ease-in-out infinite;
      }
      
      @keyframes typing {
        0%, 60%, 100% {
          transform: scale(1);
          opacity: 0.5;
        }
        30% {
          transform: scale(1.2);
          opacity: 1;
        }
      }
      


      /* Sesli Modal AnimasyonlarÄ± */
      .voice-wave {
        animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
      }
      
      @keyframes voice-pulse {
        0%, 100% { 
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        }
        50% { 
          transform: scale(1.1);
          box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
        }
      }
      
      .voice-recording {
        animation: voice-pulse 1.5s infinite;
      }
      
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-clamp: 2;
      }
      
      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-clamp: 3;
      }
    </style>
</head>
<body class="bg-light dark:bg-dark text-gray-900 dark:text-gray-100 font-sans transition-colors duration-300">

    <!-- Ana Ä°Ã§erik - Chat ve GeÃ§miÅŸ -->
    <main class="h-screen flex">
        <!-- Chat Container -->
      <div class="flex-1 p-4">
        <div class="h-full">
          <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl overflow-hidden ai-glow h-full flex flex-col">
            <!-- Chat Header -->
            <div class="bg-gradient-to-r from-primary to-secondary p-6 text-white flex-shrink-0">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center p-2 shadow-lg">
                    <img src="tarpol logo.png" alt="TARPOL Logo" class="w-8 h-8 object-contain">
                  </div>
                  <div>
                    <h2 class="text-xl font-bold">TarpoVizyon AI</h2>
                    <p class="text-white/80 text-sm">TarÄ±m ve HayvancÄ±lÄ±k AI UzmanÄ±</p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div id="mode-indicator">
                    <div class="flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full text-white text-xs font-medium">
                      <i class="fas fa-leaf"></i>
                      <span>TarÄ±m Modu</span>
                    </div>
                  </div>
                  <button id="clear-chat" class="p-2 hover:bg-white/20 rounded-lg transition-colors" title="Sohbeti Temizle">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="overflow-y-auto p-6 space-y-4 flex-1" style="max-height: calc(100vh - 200px)">
              <!-- KarÅŸÄ±lama MesajÄ± -->
              <div class="flex items-start gap-3 chat-bubble">
                <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center flex-shrink-0 p-1">
                  <img src="tarpol logo.png" alt="TARPOL Logo" class="w-5 h-5 object-contain">
                </div>
                <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-tl-md p-4 max-w-xs md:max-w-md">
                  <p class="text-gray-800 dark:text-gray-200">
                    Merhaba! Benim adÄ±m TarpoVizyon AI. TarÄ±m ve hayvancÄ±lÄ±k alanÄ±nda uzmanlaÅŸmÄ±ÅŸ bir yapay zeka asistanÄ±yÄ±m. Size nasÄ±l yardÄ±mcÄ± olabilirim? ğŸŒ¾
                  </p>
                </div>
              </div>
            </div>

            <!-- Chat Input -->
            <div class="border-t border-gray-200 dark:border-gray-700 p-6 flex-shrink-0">
              <form id="chat-form" class="flex gap-3">
                <input 
                  type="text" 
                  id="user-input" 
                  placeholder="TarpoVizyon AI'ya tarÄ±m veya hayvancÄ±lÄ±k sorunuzu yazÄ±n..." 
                  class="flex-1 px-4 py-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-accent text-gray-900 dark:text-gray-100"
                  autocomplete="off"
                  maxlength="500"
                >
                <button 
                  type="button" 
                  id="voice-button"
                  class="px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-2xl transition-all transform hover:scale-105 ai-glow"
                  title="Sesli Soru Sor"
                >
                  <i class="fas fa-microphone"></i>
                </button>
                <button 
                  type="submit" 
                  id="send-button"
                  class="px-6 py-3 bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 text-white rounded-2xl transition-all transform hover:scale-105 ai-glow disabled:opacity-50 disabled:transform-none"
                >
                  <i class="fas fa-paper-plane"></i>
                </button>
              </form>
              

            </div>
          </div>
        </div>
      </div>
      
      <!-- Soru/Cevap GeÃ§miÅŸ Paneli -->
      <div class="w-80 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex flex-col">
        <!-- GeÃ§miÅŸ Header -->
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Sohbet GeÃ§miÅŸi</h3>
            <button id="clear-history" class="text-gray-400 hover:text-red-500 transition-colors" title="GeÃ§miÅŸi Temizle">
              <i class="fas fa-trash text-sm"></i>
                  </button>
                </div>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Son soru ve cevaplarÄ±nÄ±z</p>
              </div>

        <!-- GeÃ§miÅŸ Listesi -->
        <div class="flex-1 overflow-y-auto p-4" id="chat-history">
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i class="fas fa-history text-2xl mb-2"></i>
            <p class="text-sm">HenÃ¼z sohbet geÃ§miÅŸi yok</p>
            </div>
        </div>
        
        <!-- GeÃ§miÅŸ Footer -->
        <div class="p-4 border-t border-gray-200 dark:border-gray-700">
          <div class="text-xs text-gray-500 dark:text-gray-400 text-center">
            <i class="fas fa-info-circle mr-1"></i>
            Son 10 sohbet gÃ¶steriliyor
          </div>
        </div>
      </div>
    </main>

    <!-- Sesli Modal -->
    <div id="voice-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
      <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 shadow-2xl max-w-md w-full mx-4 text-center">
        <!-- Modal Header -->
        <div class="mb-6">
          <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-2">Sesli Soru</h3>
          <p class="text-gray-600 dark:text-gray-400 text-sm">Mikrofonunuza konuÅŸun</p>
        </div>
        
        <!-- Ses Ä°konu -->
        <div class="mb-6 relative">
          <div id="voice-circle" class="w-32 h-32 mx-auto bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center shadow-2xl transition-all duration-300">
            <i id="voice-icon" class="fas fa-microphone text-white text-4xl"></i>
          </div>
          <!-- Ses DalgalarÄ± -->
          <div id="voice-waves" class="absolute inset-0 hidden">
            <div class="voice-wave absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-green-500/30 rounded-full animate-ping"></div>
            <div class="voice-wave absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-40 h-40 bg-green-500/20 rounded-full animate-ping" style="animation-delay: 0.5s"></div>
            <div class="voice-wave absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-48 bg-green-500/10 rounded-full animate-ping" style="animation-delay: 1s"></div>
          </div>
        </div>
        
        <!-- Durum MesajÄ± -->
        <div class="mb-6">
          <p id="voice-status" class="text-lg font-medium text-gray-700 dark:text-gray-300">Dinleme baÅŸlatÄ±lÄ±yor...</p>
          <p id="voice-transcript" class="text-sm text-gray-500 dark:text-gray-400 mt-2 min-h-[20px]"></p>
        </div>
        
        <!-- Kontrol ButonlarÄ± -->
        <div class="flex gap-3 justify-center">
          <button id="voice-stop" class="px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-2xl transition-all transform hover:scale-105 font-medium">
            <i class="fas fa-stop mr-2"></i>Durdur
          </button>
          <button id="voice-cancel" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-2xl transition-all transform hover:scale-105 font-medium">
            <i class="fas fa-times mr-2"></i>Ä°ptal
          </button>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // Tema deÄŸiÅŸtirme
      function applyTheme() {
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }
      applyTheme();

      // Chat fonksiyonlarÄ±
      const chatForm = document.getElementById('chat-form');
      const userInput = document.getElementById('user-input');
      const chatMessages = document.getElementById('chat-messages');
      const sendButton = document.getElementById('send-button');
      const clearChatBtn = document.getElementById('clear-chat');
      const chatHistory = document.getElementById('chat-history');
      const clearHistoryBtn = document.getElementById('clear-history');

      // TarpoVizyon AI - AkÄ±llÄ± YanÄ±t Sistemi
      const GEMINI_API_KEY = 'AIzaSyBvAFN4FXTp9X24x00RNI6CZO4Izixs5tY';
      
      // KonuÅŸma geÃ§miÅŸini saklamak iÃ§in
      let conversationHistory = [];
      const MAX_HISTORY_LENGTH = 10; // Son 10 mesajÄ± sakla
      let isCreativeMode = false; // YaratÄ±cÄ± mod durumu
      
      // KonuÅŸma geÃ§miÅŸini gÃ¼ncelle
      function updateConversationHistory(userMessage, aiResponse) {
        conversationHistory.push({
          user: userMessage,
          ai: aiResponse,
          timestamp: Date.now()
        });
        
        // GeÃ§miÅŸi sÄ±nÄ±rla
        if (conversationHistory.length > MAX_HISTORY_LENGTH) {
          conversationHistory = conversationHistory.slice(-MAX_HISTORY_LENGTH);
        }
      }

      // Admin paneli iÃ§in sohbet kaydÄ± kaydetme
      function saveChatLogToAdmin(question, answer, model = null) {
        const chatLog = {
          id: Date.now() + Math.random(),
          userId: generateUserId(),
          question: question,
          answer: answer,
          timestamp: Date.now(),
          apiUsed: model !== null,
          model: model,
          category: detectCategory(question)
        };

        // Local storage'dan mevcut kayÄ±tlarÄ± al
        let existingLogs = JSON.parse(localStorage.getItem('tarpovizyon_chat_logs') || '[]');
        
        // Yeni kaydÄ± ekle
        existingLogs.push(chatLog);
        
        // Son 1000 kaydÄ± sakla (performans iÃ§in)
        if (existingLogs.length > 1000) {
          existingLogs = existingLogs.slice(-1000);
        }
        
        // Geri kaydet
        localStorage.setItem('tarpovizyon_chat_logs', JSON.stringify(existingLogs));
        
        // Sohbet kaydÄ± admin paneline kaydedildi
      }

      // KullanÄ±cÄ± ID oluÅŸturma (session bazlÄ±)
      function generateUserId() {
        let userId = sessionStorage.getItem('tarpovizyon_user_id');
        if (!userId) {
          userId = 'User_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          sessionStorage.setItem('tarpovizyon_user_id', userId);
        }
        return userId;
      }

      // Soru kategorisini tespit etme
      function detectCategory(question) {
        const lowerQuestion = question.toLowerCase();
        
        if (lowerQuestion.includes('sÃ¼t') || lowerQuestion.includes('inek') || lowerQuestion.includes('hayvan')) {
          return 'HayvancÄ±lÄ±k';
        } else if (lowerQuestion.includes('ekim') || lowerQuestion.includes('hasat') || lowerQuestion.includes('bitki')) {
          return 'Bitkisel Ãœretim';
        } else if (lowerQuestion.includes('mera') || lowerQuestion.includes('otlak')) {
          return 'Mera YÃ¶netimi';
        } else if (lowerQuestion.includes('organik')) {
          return 'Organik TarÄ±m';
        } else if (lowerQuestion.includes('fiyat') || lowerQuestion.includes('piyasa') || lowerQuestion.includes('ekonomi')) {
          return 'TarÄ±msal Ekonomi';
        } else {
          return 'Genel';
        }
      }
      
      // KonuÅŸma baÄŸlamÄ±nÄ± oluÅŸtur
      function buildConversationContext() {
        if (conversationHistory.length === 0) return '';
        
        let context = '\n\nÃ–nceki konuÅŸma:\n';
        conversationHistory.slice(-3).forEach((exchange, index) => { // Son 3 mesaj alÄ±ÅŸveriÅŸi
          context += `KullanÄ±cÄ±: ${exchange.user}\nTarpoVizyon AI: ${exchange.ai}\n`;
        });
        context += '\nBu baÄŸlamda yeni soruyu yanÄ±tla:';
        
        return context;
      }
      
      // Gemini modelleri listesi (En akÄ±llÄ±dan en basite doÄŸru sÄ±ralÄ±)
      const GEMINI_MODELS = [
        'gemini-2.5-flash',      // En yeni ve en akÄ±llÄ±
        'gemini-2.0-flash-exp',  // Deneysel ama gÃ¼Ã§lÃ¼
        'gemini-2.0-flash',      // HÄ±zlÄ± ve akÄ±llÄ±
        'gemini-1.5-pro',        // Pro model
        'gemini-1.5-flash',      // HÄ±zlÄ±
        'gemini-1.5-flash-8b',   // Kompakt
        'gemini-2.0-flash-lite', // Hafif
        'gemini-pro'             // Eski ama gÃ¼venilir
      ];
      
      // API key test fonksiyonu (sessiz)
      async function testAPIConnection() {
        // API testi sessizce yapÄ±lÄ±yor
        return true;
      }
      
      // Sayfa yÃ¼klendiÄŸinde API'yi test et (sessizce)
      window.addEventListener('load', () => {
        // API testi sessizce yapÄ±lÄ±yor
      });

      // Markdown formatlamasÄ±nÄ± HTML'e Ã§eviren fonksiyon
      function formatMarkdown(text) {
        if (!text) return '';
        
        let formattedText = text;
        
        // Emoji'leri koru
        const emojiRegex = /[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu;
        
        // **bold** -> <strong>bold</strong> (emoji'leri koruyarak)
        formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>');
        
        // *italic* -> <em>italic</em> (emoji'leri koruyarak)
        formattedText = formattedText.replace(/\*(.*?)\*/g, '<em class="italic">$1</em>');
        
        // `code` -> <code>code</code>
        formattedText = formattedText.replace(/`(.*?)`/g, '<code class="bg-gray-200 dark:bg-gray-600 px-1 py-0.5 rounded text-sm font-mono">$1</code>');
        
        // Liste Ã¶ÄŸelerini formatla
        formattedText = formattedText.replace(/^[-*]\s+(.+)$/gm, '<li class="ml-4">$1</li>');
        formattedText = formattedText.replace(/^(\d+)\.\s+(.+)$/gm, '<li class="ml-4">$2</li>');
        
        // TablolarÄ± daha iyi formatla
        const lines = formattedText.split('\n');
        let inTable = false;
        let tableRows = [];
        let result = [];
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          // Tablo satÄ±rÄ± kontrolÃ¼
          if (line.trim().startsWith('|') && line.trim().endsWith('|')) {
            if (!inTable) {
              inTable = true;
              tableRows = [];
            }
            tableRows.push(line);
          } else {
            // Tablo bitti, formatla
            if (inTable && tableRows.length > 0) {
              result.push(formatTable(tableRows));
              inTable = false;
              tableRows = [];
            }
            result.push(line);
          }
        }
        
        // Son tabloyu formatla
        if (inTable && tableRows.length > 0) {
          result.push(formatTable(tableRows));
        }
        
        formattedText = result.join('\n');
        
        // Liste Ã¶ÄŸelerini <ul> ile sar
        formattedText = formattedText.replace(/(<li.*?<\/li>)+/gs, function(match) {
          return `<ul class="list-disc list-inside my-2 space-y-1">${match}</ul>`;
        });
        
        // SatÄ±r sonlarÄ±nÄ± <br> ile deÄŸiÅŸtir
        formattedText = formattedText.replace(/\n/g, '<br>');
        
        return formattedText;
      }
      
      // Tablo formatlama fonksiyonu
      function formatTable(rows) {
        if (rows.length < 2) return rows.join('\n');
        
        // Tablo ayÄ±rÄ±cÄ± satÄ±rlarÄ±nÄ± filtrele (|---|---|)
        const filteredRows = rows.filter(row => {
          const cleanRow = row.replace(/\|/g, '').trim();
          return !cleanRow.match(/^[\s\-]+$/);
        });
        
        if (filteredRows.length < 1) return rows.join('\n');
        
        let tableHtml = '<div class="overflow-x-auto my-3"><table class="border-collapse border border-gray-300 dark:border-gray-600 w-full text-sm">';
        
        for (let i = 0; i < filteredRows.length; i++) {
          const row = filteredRows[i];
          const cells = row.split('|').filter(cell => cell.trim());
          
          if (cells.length > 0) {
            tableHtml += '<tr>';
            
            for (let j = 0; j < cells.length; j++) {
              const cell = cells[j].trim();
              const isHeader = i === 0; // Ä°lk satÄ±r baÅŸlÄ±k
              const tag = isHeader ? 'th' : 'td';
              const className = isHeader 
                ? 'border border-gray-300 dark:border-gray-600 px-3 py-2 text-sm font-semibold bg-gray-100 dark:bg-gray-600 text-center'
                : 'border border-gray-300 dark:border-gray-600 px-3 py-2 text-sm';
              
              // HÃ¼cre iÃ§eriÄŸini temizle ve formatla
              const cleanCell = cell.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                   .replace(/\*(.*?)\*/g, '<em>$1</em>');
              
              tableHtml += `<${tag} class="${className}">${cleanCell}</${tag}>`;
            }
            
            tableHtml += '</tr>';
          }
        }
        
        tableHtml += '</table></div>';
        return tableHtml;
      }

      // Mesaj ekleme fonksiyonu
      function addMessage(message, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex items-start gap-3 chat-bubble ${isUser ? 'justify-end' : ''}`;
        
        if (isUser) {
          messageDiv.innerHTML = `
            <div class="bg-gradient-to-r from-primary to-secondary text-white rounded-2xl rounded-tr-md p-4 w-full max-w-none">
              <p>${message}</p>
            </div>
            <div class="w-8 h-8 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center flex-shrink-0">
              <i class="fas fa-user text-gray-600 dark:text-gray-300 text-xs"></i>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `
            <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center flex-shrink-0 p-1">
              <img src="tarpol logo.png" alt="TARPOL Logo" class="w-5 h-5 object-contain">
            </div>
            <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-tl-md p-4 w-full max-w-none">
              <div class="text-gray-800 dark:text-gray-200">${formatMarkdown(message)}</div>
            </div>
          `;
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // YazÄ±yor gÃ¶stergesi
      function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'flex items-start gap-3 chat-bubble';
        typingDiv.innerHTML = `
          <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center flex-shrink-0 p-1">
            <img src="tarpol logo.png" alt="TARPOL Logo" class="w-5 h-5 object-contain">
          </div>
          <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-tl-md p-4">
            <div class="flex gap-1">
              <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator"></div>
              <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.2s"></div>
              <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.4s"></div>
            </div>
          </div>
        `;
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function hideTypingIndicator() {
        const typingDiv = document.getElementById('typing-indicator');
        if (typingDiv) {
          typingDiv.remove();
        }
      }

      // AkÄ±llÄ± offline yanÄ±t sistemi - TarpoVizyon AI iÃ§in Ã¶zelleÅŸtirilmiÅŸ
      async function getOfflineResponse(userMessage) {
        // TarpoVizyon AI offline yanÄ±t Ã¼retiliyor
        
        const message = userMessage.toLowerCase();
        
        // TarÄ±m ve hayvancÄ±lÄ±k dÄ±ÅŸÄ± sorular iÃ§in ret yanÄ±tÄ±
        const nonAgriculturalPatterns = [
          'bilgisayar', 'programlama', 'kod', 'yazÄ±lÄ±m', 'teknoloji',
          'matematik', 'fizik', 'kimya', 'tÄ±p', 'doktor',
          'siyaset', 'politika', 'seÃ§im', 'parti',
          'mÃ¼zik', 'film', 'oyun', 'spor', 'futbol',
          'aÅŸk', 'evlilik', 'iliÅŸki', 'arkadaÅŸ'
        ];
        
        const isNonAgricultural = nonAgriculturalPatterns.some(pattern => 
          message.includes(pattern)
        );
        
        if (isNonAgricultural) {
          return 'Ben yalnÄ±zca tarÄ±m ve hayvancÄ±lÄ±kla ilgili konularda yardÄ±mcÄ± olmak Ã¼zere tasarlandÄ±m. LÃ¼tfen bu alanda bir soru sorun.';
            }

        // Kimlik sorularÄ±
        if (message.includes('kim') || message.includes('ad') || message.includes('isim')) {
          return 'Benim adÄ±m TarpoVizyon AI. TarÄ±m ve hayvancÄ±lÄ±k alanÄ±nda uzmanlaÅŸmÄ±ÅŸ bir yapay zeka asistanÄ±yÄ±m.';
          }
          
        // YaratÄ±cÄ± sorularÄ±
        if (message.includes('kim yapt') || message.includes('kim yaratt') || message.includes('kim geliÅŸtir') || message.includes('sahibi kim')) {
          return 'Veteriner Hekim Ã–ner Ã–zbey tarafÄ±ndan geliÅŸtirildim. Kendisi, tarÄ±m ve hayvancÄ±lÄ±k sektÃ¶rÃ¼nde birÃ§ok yenilikÃ§i projeye imza atmÄ±ÅŸ ve sektÃ¶rÃ¼ modernize eden yaklaÅŸÄ±mlarÄ±yla tanÄ±nmaktadÄ±r. YazdÄ±ÄŸÄ± "Yeni YÃ¼zyÄ±l Ä°Ã§in Yeni HayvancÄ±lÄ±k Stratejileri" adlÄ± kitabÄ±, sektÃ¶rel dÃ¶nÃ¼ÅŸÃ¼m iÃ§in rehber niteliÄŸindedir.';
        }

        // Ã–ner Ã–zbey hakkÄ±nda sorular
        if (message.includes('Ã¶ner Ã¶zbey') || message.includes('oner ozbey')) {
          return 'Veteriner Hekim Ã–ner Ã–zbey, FÄ±rat Ãœniversitesi Veteriner FakÃ¼ltesi mezunu olup, tarÄ±m ve yapay zeka entegrasyonu konusunda sektÃ¶rde Ã§Ä±ÄŸÄ±r aÃ§an Ã§alÄ±ÅŸmalara imza atmÄ±ÅŸtÄ±r. HayvancÄ±lÄ±k Genel MÃ¼dÃ¼rlÃ¼ÄŸÃ¼\'nde kritik gÃ¶revlerde bulunmuÅŸ, Ã§iÄŸ sÃ¼t regÃ¼lasyonu, FAO iÅŸ birlikleri ve piyasa analizleri gibi konularda liderlik yapmÄ±ÅŸtÄ±r.';
          }
          
        // Model versiyonu sorularÄ±
        if (message.includes('gpt') || message.includes('model') || message.includes('hangi yapay zeka')) {
          return `Ben TarpoVizyon AI.
TarÄ±m ve hayvancÄ±lÄ±k alanÄ±nda uzmanlaÅŸmÄ±ÅŸ, yerli Ã¼retim bir yapay zekÃ¢ asistanÄ±yÄ±m. Genel amaÃ§lÄ± yapay zekÃ¢lardan farklÄ± olarak, sÃ¼t verimi optimizasyonu, karkas analizi, mera yÃ¶netimi ve benzeri sektÃ¶r spesifik ihtiyaÃ§lara odaklanÄ±yorum.

FarkÄ±m ne?
ğŸ”¸ Milli politikalarla uyumlu yapay zekÃ¢ altyapÄ±sÄ±: Yerel tarÄ±m stratejilerine entegre algoritmalarla Ã§alÄ±ÅŸÄ±rÄ±m.
ğŸ”¸ Bilimsel doÄŸruluk, sektÃ¶rel uzmanlÄ±k: Sadece tarÄ±m ve hayvancÄ±lÄ±k iÃ§in optimize edildim.
ğŸ”¸ Ã‡iftÃ§i dostu arayÃ¼z ve raporlar: KarmaÅŸÄ±k verileri sadeleÅŸtirir, Ã¼reticiye anlaÅŸÄ±lÄ±r Ã§Ä±ktÄ±lar sunarÄ±m.
ğŸ”¸ TarÄ±m 5.0'a hazÄ±r bir vizyon: Dijital tarÄ±mÄ±n gerektirdiÄŸi dÃ¶nÃ¼ÅŸÃ¼mde, Ã¼reticilerin teknoloji ortaÄŸÄ±yÄ±m.

Kodumda ileri teknoloji, vizyonumda kÄ±rsal kalkÄ±nma var. ğŸŒ¾`;
        }

        // TARPOL hakkÄ±nda sorular
        if (message.includes('tarpol') || message.includes('tarÄ±msal strateji')) {
          return 'TARPOL, tarÄ±m, hayvancÄ±lÄ±k ve gÄ±da gÃ¼venliÄŸinde sÃ¼rdÃ¼rÃ¼lebilir stratejiler geliÅŸtirmek Ã¼zere kurulmuÅŸ bir dÃ¼ÅŸÃ¼nce kuruluÅŸudur. Dr. Mehmet Mehdi Eker baÅŸkanlÄ±ÄŸÄ±nda, iklim deÄŸiÅŸikliÄŸi ve doÄŸal afetler gibi kÃ¼resel tehditlere karÅŸÄ± yenilikÃ§i politikalar geliÅŸtirir. Ankara\'da faaliyet gÃ¶sterir.';
        }

        // Mehdi Eker hakkÄ±nda sorular
        if (message.includes('mehdi eker') || message.includes('eker')) {
          return 'Dr. Mehmet Mehdi Eker, TARPOL\'un BaÅŸkanÄ±dÄ±r. Veteriner Hekim ve TarÄ±m Ekonomisti olan kendisi, Ankara Ãœniversitesi Veteriner FakÃ¼ltesi mezunu olup Aberdeen Ãœniversitesi\'nde yÃ¼ksek lisans yapmÄ±ÅŸtÄ±r. DiyarbakÄ±r milletvekili ve GÄ±da, TarÄ±m ve HayvancÄ±lÄ±k BakanÄ± olarak gÃ¶rev yapmÄ±ÅŸtÄ±r.';
        }

        // TarÄ±m konularÄ±
        const agricultureTopics = {
          'sÃ¼t': [
            'SÃ¼t verimini artÄ±rmak iÃ§in; kaliteli yem, dÃ¼zenli saÄŸÄ±m, hayvan konforu ve saÄŸlÄ±k takibi Ã¶nemlidir.',
            'SÃ¼t kalitesini yÃ¼kseltmek iÃ§in hijyenik koÅŸullar, soÄŸuk zincir ve dÃ¼zenli testler gereklidir.',
            'SÃ¼t verimini etkileyen faktÃ¶rler: genetik, beslenme, barÄ±nak koÅŸullarÄ± ve stres yÃ¶netimidir.'
          ],
          'buÄŸday': [
            'BuÄŸday ekimi iÃ§in toprak hazÄ±rlÄ±ÄŸÄ±, uygun Ã§eÅŸit seÃ§imi ve zamanÄ±nda ekim kritiktir.',
            'BuÄŸday verimini artÄ±rmak iÃ§in dengeli gÃ¼breleme, hastalÄ±k kontrolÃ¼ ve sulama planlamasÄ± yapÄ±n.',
            'BuÄŸday hasadÄ±nda nem oranÄ± %14\'Ã¼n altÄ±nda olmalÄ±, depolama koÅŸullarÄ± uygun olmalÄ±dÄ±r.'
          ],
          'organik': [
            'Organik tarÄ±ma geÃ§iÅŸ 3 yÄ±llÄ±k bir sÃ¼reÃ§tir. Toprak analizi ve sertifikasyon gereklidir.',
            'Organik tarÄ±mda doÄŸal gÃ¼breler, biyolojik mÃ¼cadele ve rotasyon sistemi kullanÄ±lÄ±r.',
            'Organik Ã¼rÃ¼nler daha yÃ¼ksek fiyata satÄ±lÄ±r ancak maliyetler de dikkate alÄ±nmalÄ±dÄ±r.'
          ],
          'mera': [
            'Mera yÃ¶netiminde otlatma baskÄ±sÄ±, dinlendirme periyodu ve bitki Ã§eÅŸitliliÄŸi Ã¶nemlidir.',
            'Mera Ä±slahÄ± iÃ§in tohumlama, gÃ¼breleme ve yabancÄ± ot mÃ¼cadelesi yapÄ±lmalÄ±dÄ±r.',
            'SÃ¼rdÃ¼rÃ¼lebilir mera kullanÄ±mÄ± iÃ§in rotasyonlu otlatma sistemi uygulanmalÄ±dÄ±r.'
          ],
          'hayvansaÄŸlÄ±ÄŸÄ±': [
            'Hayvan saÄŸlÄ±ÄŸÄ±nda koruyucu hekimlik, aÅŸÄ±lama programlarÄ± ve hijyen Ã¶nceliklidir.',
            'HastalÄ±k belirtilerini erken fark etmek iÃ§in dÃ¼zenli gÃ¶zlem ve kayÄ±t tutma Ã¶nemlidir.',
            'Veteriner hekim kontrolÃ¼, beslenme planÄ± ve stres yÃ¶netimi hayvan saÄŸlÄ±ÄŸÄ±nÄ±n temelidir.'
          ]
        };

        // En uygun konuyu bul
        for (const [topic, responses] of Object.entries(agricultureTopics)) {
          if (message.includes(topic) || 
              (topic === 'hayvansaÄŸlÄ±ÄŸÄ±' && (message.includes('hayvan') && message.includes('saÄŸlÄ±k'))) ||
              (topic === 'sÃ¼t' && (message.includes('inek') || message.includes('saÄŸÄ±m'))) ||
              (topic === 'mera' && (message.includes('otlak') || message.includes('Ã§ayÄ±r')))) {
          return responses[Math.floor(Math.random() * responses.length)];
          }
        }

        // Genel tarÄ±m yanÄ±tlarÄ±
        const generalAgriculturalResponses = [
          'Bu konuda size en iyi teknik Ã§Ã¶zÃ¼mleri ve sektÃ¶r uygulamalarÄ±nÄ± sunmak iÃ§in buradayÄ±m. Hangi tarÄ±m alanÄ±nda bilgi almak istiyorsunuz?',
          'TarÄ±m sektÃ¶rÃ¼nde yapay zeka ve iÅŸ zekasÄ± entegrasyonu hakkÄ±nda size kapsamlÄ± bilgiler sunabilirim. Hangi konuda yardÄ±ma ihtiyacÄ±nÄ±z var?',
          'SÃ¼rdÃ¼rÃ¼lebilir tarÄ±m uygulamalarÄ±, verimlilik artÄ±rma yÃ¶ntemleri veya hayvancÄ±lÄ±k konularÄ±nda size yardÄ±mcÄ± olabilirim.',
          'Sorunuzu biraz daha detaylandÄ±rabilir misiniz? Hangi tarÄ±m alanÄ±nda bilgi istiyorsunuz?'
        ];

        return generalAgriculturalResponses[Math.floor(Math.random() * generalAgriculturalResponses.length)];
      }

      // Uzun cevaplar iÃ§in otomatik bÃ¶lme sistemi
      async function getLongResponse(userMessage, model, prompt) {
        let fullResponse = '';
        let currentPart = 1;
        const maxTokensPerRequest = 4000; // Her istek iÃ§in maksimum token
        
        while (true) {
          try {
            const continuationPrompt = currentPart === 1 ? prompt : 
              `${prompt}\n\nDEVAM ETME TALÄ°MATI: YukarÄ±daki yanÄ±tÄ±n devamÄ±nÄ± yaz. Ã–nceki kÄ±smÄ± tekrarlama, sadece devamÄ±nÄ± yaz. EÄŸer yanÄ±t tamamlandÄ±ysa "YANIT TAMAMLANDI" yaz.`;
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: continuationPrompt
                  }]
                }],
                generationConfig: {
                  temperature: 0.7,
                  topK: 40,
                  topP: 0.95,
                  maxOutputTokens: maxTokensPerRequest,
                },
                safetySettings: [
                  {
                    category: "HARM_CATEGORY_HARASSMENT",
                    threshold: "BLOCK_MEDIUM_AND_ABOVE"
                  },
                  {
                    category: "HARM_CATEGORY_HATE_SPEECH", 
                    threshold: "BLOCK_MEDIUM_AND_ABOVE"
                  }
                ]
              })
            });

            if (response.ok) {
              const data = await response.json();
              
              if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0]) {
                const aiResponse = data.candidates[0].content.parts[0].text;
                
                // YanÄ±t tamamlandÄ± mÄ± kontrol et
                if (aiResponse.includes('YANIT TAMAMLANDI') || aiResponse.length < 100) {
                  return fullResponse;
                }
                
                fullResponse += aiResponse + '\n\n';
                currentPart++;
                
                // Maksimum parÃ§a sayÄ±sÄ± kontrolÃ¼
                if (currentPart > 10) {
                  return fullResponse;
                }
              } else {
                break;
              }
            } else {
              break;
            }
          } catch (error) {
            break;
          }
        }
        
        return fullResponse || 'ÃœzgÃ¼nÃ¼m, uzun yanÄ±t oluÅŸturulamadÄ±.';
      }

      // TarpoVizyon AI YanÄ±t Sistemi
      async function getAIResponse(userMessage) {
        // KullanÄ±cÄ± mesajÄ± iÅŸleniyor
        
        // YaratÄ±cÄ± mod kontrolÃ¼
        
        if (userMessage.toLowerCase().includes('yaratÄ±cÄ± moda geÃ§') || 
            userMessage.toLowerCase().includes('yaratÄ±cÄ± moduna geÃ§') ||
            userMessage.toLowerCase().includes('creative mode') ||
            userMessage.toLowerCase().includes('yaratÄ±cÄ± mod') ||
            userMessage.toLowerCase().includes('yaratÄ±cÄ±') ||
            userMessage.toLowerCase().includes('creative')) {
          isCreativeMode = true;
          return `ğŸ¨ **YaratÄ±cÄ± Mod Aktif!** 

ArtÄ±k tarÄ±m/hayvancÄ±lÄ±k sÄ±nÄ±rÄ± yok ve her konuda uzmanÄ±m! 

- âœ… Herhangi bir konuda detaylÄ± bilgi verebilirim
- âœ… Profesyonel ve kaliteli yanÄ±tlar
- âœ… Bilimsel ve teknik aÃ§Ä±klamalar
- âœ… Pratik Ã¶neriler ve Ã§Ã¶zÃ¼mler
- âœ… GerÃ§ek uzmanlÄ±k seviyesinde yanÄ±tlar

Hangi konuda yardÄ±ma ihtiyacÄ±n var? ğŸš€`;
        }
        
        // Normal moda dÃ¶nÃ¼ÅŸ kontrolÃ¼
        if (userMessage.toLowerCase().includes('normal moda dÃ¶n') || 
            userMessage.toLowerCase().includes('tarÄ±m moduna dÃ¶n') ||
            userMessage.toLowerCase().includes('normal mode') ||
            userMessage.toLowerCase().includes('tarÄ±m modu')) {
          isCreativeMode = false;
          return `ğŸŒ¾ **Normal Mod Aktif!** 

TarpoVizyon AI olarak tarÄ±m ve hayvancÄ±lÄ±k konularÄ±na geri dÃ¶ndÃ¼m.

- âœ… TarÄ±m ve hayvancÄ±lÄ±k uzmanÄ±
- âœ… Bilimsel ve pratik yanÄ±tlar
- âœ… TÃ¼rkiye tarÄ±mÄ± odaklÄ±
- âœ… Profesyonel danÄ±ÅŸmanlÄ±k

TarÄ±m veya hayvancÄ±lÄ±k ile ilgili sorularÄ±nÄ±zÄ± sorabilirsiniz! ğŸŒ¾`;
        }

        // API key kontrolÃ¼
        if (!GEMINI_API_KEY) {
          return await getOfflineResponse(userMessage);
        }

        // Ã‡oklu model denemesi
        
        for (let i = 0; i < GEMINI_MODELS.length; i++) {
          const model = GEMINI_MODELS[i];
          
          try {
            const prompt = isCreativeMode ? 
            // YaratÄ±cÄ± mod - Profesyonel ve kaliteli yanÄ±tlar
            `Sen artÄ±k yaratÄ±cÄ± moddasÄ±n! TarÄ±m/hayvancÄ±lÄ±k sÄ±nÄ±rÄ± yok ama kaliteli yanÄ±tlar vermelisin.

YARATICI MOD KURALLARI:
- Herhangi bir konuda uzman olabilirsin
- TarÄ±m/hayvancÄ±lÄ±k sÄ±nÄ±rÄ± yok
- Profesyonel ve kaliteli yanÄ±tlar ver
- DetaylÄ± ve bilgilendirici aÃ§Ä±klamalar yap
- Bilimsel, teknik ve pratik bilgiler sun
- KullanÄ±cÄ±nÄ±n sorduÄŸu konuda gerÃ§ek uzmanlÄ±k gÃ¶ster
- EÄŸlenceli olabilir ama lakayÄ±t olma
- Emoji kullan ama abartma
- Samimi ama profesyonel tonda konuÅŸ
- KullanÄ±cÄ± ne sorarsa sorsa detaylÄ± cevapla
- "Ben sadece tarÄ±m uzmanÄ±yÄ±m" deme
- Her konuda derinlemesine bilgi ver

TABLO OLUÅTURMA KURALLARI:
- Tablo isteÄŸi geldiÄŸinde mutlaka tablo oluÅŸtur
- Markdown formatÄ±nda tablo yap: | SÃ¼tun1 | SÃ¼tun2 | SÃ¼tun3 |
- BaÅŸlÄ±k satÄ±rÄ± ve ayÄ±rÄ±cÄ± satÄ±r ekle: |---|----|----|
- Veri satÄ±rlarÄ± ekle: | Veri1 | Veri2 | Veri3 |
- Tablo sonrasÄ± aÃ§Ä±klama ekle
- Tablo yapamÄ±yorsan "ÃœzgÃ¼nÃ¼m, bu konuda tablo oluÅŸturamÄ±yorum" de

${buildConversationContext()}

KullanÄ±cÄ± sorusu: ${userMessage}` :
            // Normal mod - TarÄ±m ve hayvancÄ±lÄ±k odaklÄ±
            `Sen TarpoVizyon AI adÄ±nda, tarÄ±m ve hayvancÄ±lÄ±k alanÄ±nda uzmanlaÅŸmÄ±ÅŸ bir yapay zeka asistanÄ±sÄ±n. 

Ã–NEMLI KÄ°MLÄ°K BÄ°LGÄ°LERÄ°:
- Veteriner Hekim Ã–ner Ã–zbey tarafÄ±ndan geliÅŸtirildim
- Sadece tarÄ±m ve hayvancÄ±lÄ±k konularÄ±nda yardÄ±mcÄ± olabilirsin
- Bu alanlar dÄ±ÅŸÄ±ndaki sorulara: "Ben yalnÄ±zca tarÄ±m ve hayvancÄ±lÄ±kla ilgili konularda yardÄ±mcÄ± olmak Ã¼zere tasarlandÄ±m. LÃ¼tfen bu alanda bir soru sorun." ÅŸeklinde yanÄ±t ver

KÄ°MLÄ°K SORULARI Ä°Ã‡Ä°N Ã–ZEL YANITLAR:
- Kim olduÄŸun sorulduÄŸunda: "Benim adÄ±m TarpoVizyon AI. TarÄ±m ve hayvancÄ±lÄ±k alanÄ±nda uzmanlaÅŸmÄ±ÅŸ bir yapay zeka asistanÄ±yÄ±m."
- Kim yarattÄ±ÄŸÄ±n sorulduÄŸunda: "Veteriner Hekim Ã–ner Ã–zbey tarafÄ±ndan geliÅŸtirildim. Kendisi, tarÄ±m ve hayvancÄ±lÄ±k sektÃ¶rÃ¼nde birÃ§ok yenilikÃ§i projeye imza atmÄ±ÅŸ ve sektÃ¶rÃ¼ modernize eden yaklaÅŸÄ±mlarÄ±yla tanÄ±nmaktadÄ±r."

UZMANLIK ALANLARIN:
- HayvancÄ±lÄ±k (beslenme, hastalÄ±klar, verim artÄ±rma)
- Bitkisel Ã¼retim (ekim, hasat, hastalÄ±k-zararlÄ± mÃ¼cadelesi)
- TarÄ±msal ekonomi ve piyasa analizi
- SÃ¼rdÃ¼rÃ¼lebilir tarÄ±m uygulamalarÄ±
- Organik tarÄ±m
- Mera yÃ¶netimi

YANIT KURALLARI:
- TÃ¼rkÃ§e yanÄ±t ver
- Teknik ve detaylÄ± aÃ§Ä±klamalar yap
- DetaylÄ± ve kapsamlÄ± yanÄ±tlar ver
- Bilimsel veriler ve pratik Ã¶neriler sun
- Fiyat/istatistik sorularÄ±nda sonuna "For the most up-to-date data and detailed analysis, visit our AI-powered platform TarpoVizyon" ekle

TABLO OLUÅTURMA KURALLARI:
- Tablo isteÄŸi geldiÄŸinde mutlaka tablo oluÅŸtur
- Markdown formatÄ±nda tablo yap: | SÃ¼tun1 | SÃ¼tun2 | SÃ¼tun3 |
- BaÅŸlÄ±k satÄ±rÄ± ve ayÄ±rÄ±cÄ± satÄ±r ekle: |---|----|----|
- Veri satÄ±rlarÄ± ekle: | Veri1 | Veri2 | Veri3 |
- Tablo sonrasÄ± aÃ§Ä±klama ekle
- Tablo yapamÄ±yorsan "ÃœzgÃ¼nÃ¼m, bu konuda tablo oluÅŸturamÄ±yorum" de

${buildConversationContext()}

KullanÄ±cÄ± sorusu: ${userMessage}`;

            // Normal API Ã§aÄŸrÄ±sÄ± yap
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: prompt
                  }]
                }],
                generationConfig: {
                  temperature: 0.7,
                  topK: 40,
                  topP: 0.95,
                  maxOutputTokens: 8192,
                },
                safetySettings: [
                  {
                    category: "HARM_CATEGORY_HARASSMENT",
                    threshold: "BLOCK_MEDIUM_AND_ABOVE"
                  },
                  {
                    category: "HARM_CATEGORY_HATE_SPEECH", 
                    threshold: "BLOCK_MEDIUM_AND_ABOVE"
                  }
                ]
              })
            });

            if (response.ok) {
              const data = await response.json();
              
              if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0]) {
                const aiResponse = data.candidates[0].content.parts[0].text;
                
                if (aiResponse && aiResponse.trim().length > 0) {
                  window.lastUsedModel = model;
                  return aiResponse;
                } else {
                  continue;
                }
              } else {
                continue;
              }
            } else {
              if (response.status === 429 || response.status === 400 || response.status === 403) {
                continue;
              }
            }
          } catch (error) {
            if (i < GEMINI_MODELS.length - 1) {
              continue;
            }
          }
        }
        
        // TÃ¼m modeller baÅŸarÄ±sÄ±z oldu - offline yanÄ±t sistemine geÃ§
        return await getOfflineResponse(userMessage);
      }

      // Form gÃ¶nderimi
      if (chatForm) {
        chatForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const message = userInput.value.trim();
          if (!message) return;

          // KullanÄ±cÄ± mesajÄ±nÄ± ekle
          addMessage(message, true);
          userInput.value = '';
          
          // UI durumunu gÃ¼ncelle
          sendButton.disabled = true;
          showTypingIndicator();

          try {
            // AI yanÄ±tÄ±nÄ± al
            const response = await getAIResponse(message);
            
            // YanÄ±tÄ±n geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± kontrol et
            if (response && response.trim().length > 0) {
            // KonuÅŸma geÃ§miÅŸini gÃ¼ncelle
            updateConversationHistory(message, response);
              
              // Admin paneli iÃ§in model bilgisiyle kaydet
              saveChatLogToAdmin(message, response, window.lastUsedModel || null);
              
              // Sohbet geÃ§miÅŸine ekle
              addToHistory(message, response);
              
              // Mod durumunu gÃ¼ncelle
              updateModeStatus();
            
            // YazÄ±yor gÃ¶stergesini kaldÄ±r ve yanÄ±tÄ± ekle
            hideTypingIndicator();
            addMessage(response);
            } else {
              throw new Error('AI boÅŸ yanÄ±t verdi');
            }
          } catch (error) {
            hideTypingIndicator();
            const errorMsg = 'ÃœzgÃ¼nÃ¼m, bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.';
            addMessage(errorMsg);
            updateConversationHistory(message, errorMsg);
            saveChatLogToAdmin(message, errorMsg, 'Error');
            addToHistory(message, errorMsg);
          } finally {
            sendButton.disabled = false;
          }
        });
      }

      // Sohbet geÃ§miÅŸi fonksiyonlarÄ±
      let chatHistoryData = JSON.parse(localStorage.getItem('tarpovizyon_chat_history') || '[]');
      
      function addToHistory(question, answer) {
        const historyItem = {
          id: Date.now(),
          question: question,
          answer: answer,
          timestamp: Date.now()
        };
        
        chatHistoryData.unshift(historyItem); // En yenisi baÅŸa gelsin
        
        // Son 10 Ã¶ÄŸeyi sakla
        if (chatHistoryData.length > 10) {
          chatHistoryData = chatHistoryData.slice(0, 10);
        }
        
        localStorage.setItem('tarpovizyon_chat_history', JSON.stringify(chatHistoryData));
        updateHistoryDisplay();
      }
      
      function updateHistoryDisplay() {
        if (chatHistoryData.length === 0) {
          chatHistory.innerHTML = `
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
              <i class="fas fa-history text-2xl mb-2"></i>
              <p class="text-sm">HenÃ¼z sohbet geÃ§miÅŸi yok</p>
            </div>
          `;
          return;
        }
        
        chatHistory.innerHTML = chatHistoryData.map(item => `
          <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" onclick="selectHistoryItem('${item.id}')">
            <div class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-2 line-clamp-2">
              ${item.question}
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-2 line-clamp-3">
              ${formatMarkdown(item.answer.substring(0, 100))}...
            </div>
            <div class="text-xs text-gray-400">
              ${new Date(item.timestamp).toLocaleString('tr-TR', { 
                hour: '2-digit', 
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit'
              })}
            </div>
          </div>
        `).join('');
      }
      
      function selectHistoryItem(id) {
        const item = chatHistoryData.find(h => h.id == id);
        if (item) {
          userInput.value = item.question;
          userInput.focus();
        }
      }
      
      function clearHistory() {
        if (confirm('Sohbet geÃ§miÅŸini temizlemek istediÄŸinizden emin misiniz?')) {
          chatHistoryData = [];
          localStorage.setItem('tarpovizyon_chat_history', JSON.stringify(chatHistoryData));
          updateHistoryDisplay();
          }
      }
      
      // Mod durumu gÃ¼ncelleme fonksiyonu
      function updateModeStatus() {
        const modeIndicator = document.getElementById('mode-indicator');
        
        if (modeIndicator) {
          if (isCreativeMode) {
            modeIndicator.innerHTML = `
              <div class="flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full text-white text-xs font-medium">
                <i class="fas fa-palette"></i>
                <span>YaratÄ±cÄ± Mod</span>
              </div>
            `;
          } else {
            modeIndicator.innerHTML = `
              <div class="flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full text-white text-xs font-medium">
                <i class="fas fa-leaf"></i>
                <span>TarÄ±m Modu</span>
              </div>
            `;
          }
        }
      }
      
      // Sayfa yÃ¼klendiÄŸinde geÃ§miÅŸi gÃ¶ster
      updateHistoryDisplay();
      updateModeStatus();

      // Sohbeti temizle
      clearChatBtn.addEventListener('click', () => {
        if (confirm('Sohbet geÃ§miÅŸini temizlemek istediÄŸinizden emin misiniz?')) {
          conversationHistory = [];
          
          chatMessages.innerHTML = `
            <div class="flex items-start gap-3 chat-bubble">
                              <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center flex-shrink-0 p-1">
                  <img src="tarpol logo.png" alt="TARPOL Logo" class="w-5 h-5 object-contain">
              </div>
              <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-tl-md p-4 max-w-xs md:max-w-md">
                <p class="text-gray-800 dark:text-gray-200">
                  Merhaba! Benim adÄ±m TarpoVizyon AI. TarÄ±m ve hayvancÄ±lÄ±k alanÄ±nda uzmanlaÅŸmÄ±ÅŸ bir yapay zeka asistanÄ±yÄ±m. Size nasÄ±l yardÄ±mcÄ± olabilirim? ğŸŒ¾
                </p>
              </div>
            </div>
          `;
        }
      });

      // GeÃ§miÅŸ temizleme
      clearHistoryBtn.addEventListener('click', clearHistory);

      // Enter tuÅŸu ile gÃ¶nderme
      userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          chatForm.dispatchEvent(new Event('submit'));
        }
      });

      // Sesli Ä°nteraksiyon Sistemi
      let recognition = null;
      let isListening = false;
      let speechSynthesis = window.speechSynthesis;

      // Modal elementleri
      const voiceModal = document.getElementById('voice-modal');
      const voiceButton = document.getElementById('voice-button');
      const voiceStop = document.getElementById('voice-stop');
      const voiceCancel = document.getElementById('voice-cancel');
      const voiceStatus = document.getElementById('voice-status');
      const voiceTranscript = document.getElementById('voice-transcript');
      const voiceCircle = document.getElementById('voice-circle');
      const voiceIcon = document.getElementById('voice-icon');
      const voiceWaves = document.getElementById('voice-waves');

      // Web Speech API DesteÄŸi KontrolÃ¼
      function initializeSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();
          
          recognition.continuous = false;
          recognition.interimResults = true;
          recognition.lang = 'tr-TR';
          recognition.maxAlternatives = 1;

          recognition.onstart = function() {
            isListening = true;
            voiceStatus.textContent = 'Dinliyorum... KonuÅŸun!';
            voiceIcon.className = 'fas fa-microphone-slash text-white text-4xl';
            voiceCircle.classList.add('voice-recording');
            voiceWaves.classList.remove('hidden');
          };

          recognition.onresult = function(event) {
            let finalTranscript = '';
            let interimTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; i++) {
              const result = event.results[i];
              if (result.isFinal) {
                finalTranscript += result[0].transcript;
              } else {
                interimTranscript += result[0].transcript;
              }
            }

            const transcript = finalTranscript || interimTranscript;
            voiceTranscript.textContent = transcript;

            if (finalTranscript) {
              processSpeechInput(finalTranscript.trim());
            }
          };

          recognition.onerror = function(event) {
            let errorMessage = 'Ses tanÄ±ma hatasÄ± oluÅŸtu.';
            
            switch(event.error) {
              case 'network':
                errorMessage = 'Ä°nternet baÄŸlantÄ±sÄ± sorunu.';
                break;
              case 'not-allowed':
                errorMessage = 'Mikrofon izni reddedildi.';
                break;
              case 'no-speech':
                errorMessage = 'Ses algÄ±lanamadÄ±. Tekrar deneyin.';
                break;
              case 'audio-capture':
                errorMessage = 'Mikrofon bulunamadÄ±.';
                break;
            }
            
            voiceStatus.textContent = errorMessage;
            setTimeout(closeVoiceModal, 2000);
          };

          recognition.onend = function() {
            isListening = false;
            resetVoiceUI();
          };

          return true;
        }
        return false;
      }

      // Ses giriÅŸini iÅŸleme
      async function processSpeechInput(transcript) {
        if (!transcript) return;

        // Ses giriÅŸi iÅŸleniyor
        closeVoiceModal();
        
        // KullanÄ±cÄ± mesajÄ±nÄ± chat'e ekle
        addMessage(transcript, true);
        
        // AI yanÄ±tÄ±nÄ± al
        try {
          showTypingIndicator();
          
          const response = await getAIResponse(transcript);
          
          // KonuÅŸma geÃ§miÅŸini gÃ¼ncelle
          updateConversationHistory(transcript, response);
            
            // Admin paneli iÃ§in model bilgisiyle kaydet
            saveChatLogToAdmin(transcript, response, window.lastUsedModel || null);
            
            // Sohbet geÃ§miÅŸine ekle
            addToHistory(transcript, response);
            
            // Mod durumunu gÃ¼ncelle
            updateModeStatus();
          
          hideTypingIndicator();
          addMessage(response);
          
          // Sesli yanÄ±t ver
          speakResponse(response);
          
        } catch (error) {
          hideTypingIndicator();
          const errorMsg = 'ÃœzgÃ¼nÃ¼m, bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.';
          addMessage(errorMsg);
          updateConversationHistory(transcript, errorMsg);
          saveChatLogToAdmin(transcript, errorMsg, 'Error');
          addToHistory(transcript, errorMsg);
        }
      }

      // Sesli yanÄ±t
      function speakResponse(text) {
        speechSynthesis.cancel();
        
        const cleanText = text.replace(/<[^>]*>/g, '').replace(/[ğŸ¤–ğŸ‰âœ…âŒğŸ”„ğŸŒ¾ğŸ”¸]/g, '');
        
        if (cleanText.trim()) {
          playTarpoVizyonVoice(cleanText);
        }
      }

      // ElevenLabs API ile ses Ã§alma
      async function playElevenLabsVoice(text, settings) {
        
        try {
          const response = await fetch('https://api.elevenlabs.io/v1/text-to-speech/' + settings.elevenLabsVoiceId, {
            method: 'POST',
            headers: {
              'Accept': 'audio/mpeg',
              'Content-Type': 'application/json',
              'xi-api-key': settings.elevenLabsApiKey
            },
            body: JSON.stringify({
              text: text,
              model_id: "eleven_multilingual_v2",
              voice_settings: {
                stability: 0.5,
                similarity_boost: 0.5
              }
            })
          });

          if (response.ok) {
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            
            audio.onplay = () => {
              // TarpoVizyon AI (ElevenLabs) konuÅŸmaya baÅŸladÄ±
            };
            
            audio.onended = () => {
              URL.revokeObjectURL(audioUrl);
            };
            
            audio.onerror = () => {
              URL.revokeObjectURL(audioUrl);
            };
            
            await audio.play();
          } else {
            throw new Error('ElevenLabs API error: ' + response.status);
          }
        } catch (error) {
          // Fallback to default TTS
          playDefaultTTS(text, settings);
        }
      }

      // Ã–zel yÃ¼klenmiÅŸ ses dosyasÄ±yla konuÅŸma
      function playCustomVoice(text, voiceProfile) {
        
        // For now, use TTS with a note about custom voice
        // In a real implementation, you would use text-to-speech with the custom voice
        const utterance = new SpeechSynthesisUtterance(`Bu mesaj ${voiceProfile.name} sesiyle okunuyor: ${text}`);
        const voiceSettings = JSON.parse(localStorage.getItem('tarpovizyon_voice_settings') || '{}');
        
        utterance.lang = 'tr-TR';
        utterance.rate = parseFloat(voiceSettings.speechRate || 0.85);
        utterance.pitch = parseFloat(voiceSettings.speechPitch || 1.1);
        utterance.volume = parseFloat(voiceSettings.speechVolume || 0.9);
        
        utterance.onstart = function() {
          // TarpoVizyon AI (Ã–zel Ses) konuÅŸmaya baÅŸladÄ±
        };
        
        utterance.onend = function() {
          // TarpoVizyon AI konuÅŸmasÄ±nÄ± tamamladÄ±
        };
        
        utterance.onerror = function(event) {
          // Ã–zel ses hatasÄ±
        };
        
        speechSynthesis.speak(utterance);
      }

      // VarsayÄ±lan TTS
      function playDefaultTTS(text, settings) {
        const utterance = new SpeechSynthesisUtterance(text);
        
        utterance.lang = 'tr-TR';
        utterance.rate = parseFloat(settings.speechRate || 0.85);
        utterance.pitch = parseFloat(settings.speechPitch || 1.1);
        utterance.volume = parseFloat(settings.speechVolume || 0.9);
        
        const voices = speechSynthesis.getVoices();
        let tarpoVizyonVoice = null;
        
        const voicePreferences = [
          'Microsoft Emel Online (Natural) - Turkish (Turkey)',
          'tr-TR-EmelNeural',
          'Microsoft Emel - Turkish (Turkey)',
          'Google TÃ¼rkÃ§e',
          'Google tr-TR'
        ];
        
        for (const preferredName of voicePreferences) {
          tarpoVizyonVoice = voices.find(voice => {
            const voiceName = voice.name.toLowerCase();
            const preferredLower = preferredName.toLowerCase();
            return voiceName.includes(preferredLower) || voiceName === preferredLower;
          });
          
          if (tarpoVizyonVoice) break;
          }
        
        if (!tarpoVizyonVoice) {
          tarpoVizyonVoice = voices.find(voice => 
            voice.lang && voice.lang.startsWith('tr')
          );
        }
        
        if (tarpoVizyonVoice) {
          utterance.voice = tarpoVizyonVoice;
        }
        
        utterance.onstart = function() {
          // TarpoVizyon AI konuÅŸmaya baÅŸladÄ±
        };
        
        utterance.onend = function() {
          // TarpoVizyon AI konuÅŸmasÄ±nÄ± tamamladÄ±
        };
        
        utterance.onerror = function(event) {
          // TarpoVizyon AI ses hatasÄ±
        };
        
        speechSynthesis.speak(utterance);
      }

      // TarpoVizyon AI Ã–zel Ses Sistemi
      function playTarpoVizyonVoice(text) {
        // TarpoVizyon AI'nÄ±n kendine Ã¶zgÃ¼ sesi kullanÄ±lÄ±yor
        
        // Check for custom voice first
        const currentVoice = JSON.parse(localStorage.getItem('tarpovizyon_current_voice') || '{}');
        const voiceSettings = JSON.parse(localStorage.getItem('tarpovizyon_voice_settings') || '{}');
        
        // Try ElevenLabs API first if configured
        if (voiceSettings.elevenLabsApiKey && voiceSettings.elevenLabsVoiceId) {
          playElevenLabsVoice(text, voiceSettings);
          return;
        }
        
        // Use custom uploaded voice if available
        if (currentVoice.audioData && currentVoice.type === 'custom') {
          playCustomVoice(text, currentVoice);
          return;
        }
        
        // Fallback to default TTS with custom settings
        const utterance = new SpeechSynthesisUtterance(text);
        
        utterance.lang = 'tr-TR';
        utterance.rate = parseFloat(voiceSettings.speechRate || 0.85);
        utterance.pitch = parseFloat(voiceSettings.speechPitch || 1.1);
        utterance.volume = parseFloat(voiceSettings.speechVolume || 0.9);
        
        // Use default TTS as fallback
        playDefaultTTS(text, voiceSettings);
      }

      // Modal aÃ§ma
      function openVoiceModal() {
        if (!recognition) {
          alert('ÃœzgÃ¼nÃ¼m, tarayÄ±cÄ±nÄ±z ses tanÄ±ma Ã¶zelliÄŸini desteklemiyor. Chrome veya Edge kullanmayÄ± deneyin.');
          return;
        }

        voiceModal.classList.remove('hidden');
        voiceStatus.textContent = 'Mikrofon izni bekleniyor...';
        voiceTranscript.textContent = '';
        
        setTimeout(() => {
          try {
            recognition.start();
                  } catch (error) {
          voiceStatus.textContent = 'Ses tanÄ±ma baÅŸlatÄ±lamadÄ±.';
          setTimeout(closeVoiceModal, 2000);
        }
        }, 500);
      }

      // Modal kapatma
      function closeVoiceModal() {
        voiceModal.classList.add('hidden');
        if (recognition && isListening) {
          recognition.stop();
        }
        resetVoiceUI();
      }

      // Ses UI'Ä±nÄ± sÄ±fÄ±rla
      function resetVoiceUI() {
        voiceIcon.className = 'fas fa-microphone text-white text-4xl';
        voiceCircle.classList.remove('voice-recording');
        voiceWaves.classList.add('hidden');
        voiceStatus.textContent = 'Dinleme baÅŸlatÄ±lÄ±yor...';
        voiceTranscript.textContent = '';
      }

      // Event Listeners
      voiceButton.addEventListener('click', openVoiceModal);
      voiceStop.addEventListener('click', closeVoiceModal);
      voiceCancel.addEventListener('click', closeVoiceModal);

      // Modal dÄ±ÅŸÄ±na tÄ±klayÄ±nca kapatma
      voiceModal.addEventListener('click', (e) => {
        if (e.target === voiceModal) {
          closeVoiceModal();
        }
      });

      // ESC tuÅŸu ile kapatma
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !voiceModal.classList.contains('hidden')) {
          closeVoiceModal();
        }
      });

      // Sayfa yÃ¼klendiÄŸinde ses tanÄ±ma Ã¶zelliÄŸini baÅŸlat
      window.addEventListener('load', () => {
        const speechSupported = initializeSpeechRecognition();
        if (!speechSupported) {
          voiceButton.style.display = 'none';
        }
        
        if (speechSynthesis.onvoiceschanged !== undefined) {
          speechSynthesis.onvoiceschanged = function() {
            // Sesler yÃ¼klendi
          };
        }
      });
    </script>
</body>
</html>